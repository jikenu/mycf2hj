<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.12" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.44" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <title>MyRPCFromZero | Home Blog</title><meta name="description" content="My first VuePress Site">
    <link rel="preload" href="/assets/style-DgAOu3aL.css" as="style"><link rel="stylesheet" href="/assets/style-DgAOu3aL.css">
    <link rel="modulepreload" href="/assets/app-BKdByfKa.js"><link rel="modulepreload" href="/assets/Rpc.html-C0cOr-zd.js">
    <link rel="prefetch" href="/assets/index.html-B0sdYNYA.js" as="script"><link rel="prefetch" href="/assets/get-started.html-B51a7tEd.js" as="script"><link rel="prefetch" href="/assets/Music.html-CCPZbOns.js" as="script"><link rel="prefetch" href="/assets/è®¡ç®—æœºç½‘ç»œä¸Š.html-VH0qKkZU.js" as="script"><link rel="prefetch" href="/assets/è®¡ç®—æœºç½‘ç»œä¸‹.html-BhSC8Veq.js" as="script"><link rel="prefetch" href="/assets/å…«è‚¡ä¸€.html-nc7PDqbp.js" as="script"><link rel="prefetch" href="/assets/å…«è‚¡äºŒ.html-DhMo-x0T.js" as="script"><link rel="prefetch" href="/assets/Video.html-BRqCYmc6.js" as="script"><link rel="prefetch" href="/assets/fofa.html-DkZVPuTd.js" as="script"><link rel="prefetch" href="/assets/pages1.html-D6vv38iH.js" as="script"><link rel="prefetch" href="/assets/site1.html-B2JIIJgR.js" as="script"><link rel="prefetch" href="/assets/hel2.html-CzVvSAKK.js" as="script"><link rel="prefetch" href="/assets/hel3.html-CWvhajJI.js" as="script"><link rel="prefetch" href="/assets/hel4.html-DpGo2hqR.js" as="script"><link rel="prefetch" href="/assets/MySQL.html-BH-dQi-X.js" as="script"><link rel="prefetch" href="/assets/MySQLåŸºç¡€ã€é”ã€äº‹åŠ¡ã€åˆ†åº“åˆ†è¡¨ã€ä¼˜åŒ–.html-Bnf0BB9_.js" as="script"><link rel="prefetch" href="/assets/MySQLç´¢å¼•è¿ç¯18é—®.html-DslqbJSy.js" as="script"><link rel="prefetch" href="/assets/Mybatis.html-iKhMmXP8.js" as="script"><link rel="prefetch" href="/assets/ORM.html-MRr96crB.js" as="script"><link rel="prefetch" href="/assets/Spring.html-Dv-RjnX2.js" as="script"><link rel="prefetch" href="/assets/utilClass.html-D7dNFCe8.js" as="script"><link rel="prefetch" href="/assets/Kafkaé¢è¯•é¢˜.html-CMlYg-BI.js" as="script"><link rel="prefetch" href="/assets/MQé¢è¯•é¢˜.html-D17Phkgf.js" as="script"><link rel="prefetch" href="/assets/Redis.html-Bc7q9A2_.js" as="script"><link rel="prefetch" href="/assets/java_base1.html-BMmYlx4t.js" as="script"><link rel="prefetch" href="/assets/java_base2.html-DXQ8utnc.js" as="script"><link rel="prefetch" href="/assets/ConcurrentHashMap.html-BBUC_ji-.js" as="script"><link rel="prefetch" href="/assets/HashMap.html-WAy1As7E.js" as="script"><link rel="prefetch" href="/assets/HashMapçº¿ç¨‹å®‰å…¨.html-B1Vkr8cU.js" as="script"><link rel="prefetch" href="/assets/Javaé›†åˆé«˜é¢‘é¢è¯•é¢˜.html-BpCm69rJ.js" as="script"><link rel="prefetch" href="/assets/AQS.html-4VWY0Dp_.js" as="script"><link rel="prefetch" href="/assets/Javaå¤šçº¿ç¨‹æ€»ç»“ç‰ˆ.html-CD_ubz0x.js" as="script"><link rel="prefetch" href="/assets/Javaå¤šçº¿ç¨‹é¢è¯•-åŸºç¡€.html-DZoR0N4l.js" as="script"><link rel="prefetch" href="/assets/å¦‚ä½•è®¾è®¡çº¿ç¨‹æ± .html-kd8LXhzT.js" as="script"><link rel="prefetch" href="/assets/è¿›ç¨‹é€šä¿¡å’Œçº¿ç¨‹é€šä¿¡çš„æ–¹å¼.html-0FN5FNUo.js" as="script"><link rel="prefetch" href="/assets/404.html-CRBgh1kn.js" as="script"><link rel="prefetch" href="/assets/index.html-BV1wHm7N.js" as="script"><link rel="prefetch" href="/assets/index.html-OflrodMe.js" as="script"><link rel="prefetch" href="/assets/index.html-DVU55qZd.js" as="script"><link rel="prefetch" href="/assets/index.html-BePLW9ZA.js" as="script"><link rel="prefetch" href="/assets/index.html-DmW_vSza.js" as="script"><link rel="prefetch" href="/assets/index.html-CPVxE6D1.js" as="script"><link rel="prefetch" href="/assets/index.html-DNgtu4bu.js" as="script"><link rel="prefetch" href="/assets/index.html-C6lPriPj.js" as="script"><link rel="prefetch" href="/assets/index.html-C83S-FVq.js" as="script"><link rel="prefetch" href="/assets/index.html-CjUHx4Lf.js" as="script"><link rel="prefetch" href="/assets/index.html-DXCrBglz.js" as="script"><link rel="prefetch" href="/assets/index.html-DBaTnT6c.js" as="script"><link rel="prefetch" href="/assets/index.html-Dl3oJyzx.js" as="script"><link rel="prefetch" href="/assets/index.html-B7n8xOr9.js" as="script"><link rel="prefetch" href="/assets/index.html-Cl2_RDOV.js" as="script"><link rel="prefetch" href="/assets/index.html-BnthcfIv.js" as="script"><link rel="prefetch" href="/assets/index.html-myRzWS6T.js" as="script"><link rel="prefetch" href="/assets/index.html-CrSs3JA8.js" as="script"><link rel="prefetch" href="/assets/index.html-0R4BNY_D.js" as="script"><link rel="prefetch" href="/assets/index.html-C62QYS8S.js" as="script"><link rel="prefetch" href="/assets/index.html-DyzGo4TP.js" as="script"><link rel="prefetch" href="/assets/index.html-06yCT1zS.js" as="script"><link rel="prefetch" href="/assets/index.html-BA2ojb-2.js" as="script"><link rel="prefetch" href="/assets/index.html--TJEFaLY.js" as="script"><link rel="prefetch" href="/assets/index.html-C0kvfRlu.js" as="script"><link rel="prefetch" href="/assets/index.html-CvVJrTN_.js" as="script"><link rel="prefetch" href="/assets/index.html-CJtDN41c.js" as="script"><link rel="prefetch" href="/assets/index.html-CauAkS49.js" as="script"><link rel="prefetch" href="/assets/index.html-Ex1afZlX.js" as="script"><link rel="prefetch" href="/assets/index.html-BJ7Cv9e3.js" as="script"><link rel="prefetch" href="/assets/index.html-DkIplsYW.js" as="script"><link rel="prefetch" href="/assets/index.html-BGsfKR-v.js" as="script"><link rel="prefetch" href="/assets/index.html-sx66WckS.js" as="script"><link rel="prefetch" href="/assets/index.html-BxC1D0HB.js" as="script"><link rel="prefetch" href="/assets/index.html-DRiDfzq9.js" as="script"><link rel="prefetch" href="/assets/index.html-skVKoMBN.js" as="script"><link rel="prefetch" href="/assets/index.html-42RLsYYw.js" as="script"><link rel="prefetch" href="/assets/index.html-ZlnJAo0L.js" as="script"><link rel="prefetch" href="/assets/index.html-CPgbOL2z.js" as="script"><link rel="prefetch" href="/assets/index.html-aAwp2CJe.js" as="script"><link rel="prefetch" href="/assets/index.html-aWmXLMqD.js" as="script"><link rel="prefetch" href="/assets/index.html-DdlleQ2g.js" as="script"><link rel="prefetch" href="/assets/index.html-CCeSdCza.js" as="script"><link rel="prefetch" href="/assets/index.html-Bo0lMcPI.js" as="script"><link rel="prefetch" href="/assets/index.html-Dcbk-yyU.js" as="script"><link rel="prefetch" href="/assets/index.html-pbVgEEMN.js" as="script"><link rel="prefetch" href="/assets/index.html-DGcWmg4-.js" as="script"><link rel="prefetch" href="/assets/index.html-OflrodMe.js" as="script"><link rel="prefetch" href="/assets/prod-DxPZqpt5.js" as="script"><link rel="prefetch" href="/assets/prod-DxPZqpt5.js" as="script"><link rel="prefetch" href="/assets/vidstack-audio-CMrYDtzf.js" as="script"><link rel="prefetch" href="/assets/vidstack-video-CstYCEQT.js" as="script"><link rel="prefetch" href="/assets/vidstack-dash-BSWklB5M.js" as="script"><link rel="prefetch" href="/assets/vidstack-hls-IF3Fs_nB.js" as="script"><link rel="prefetch" href="/assets/vidstack-vimeo-D4yDEmOV.js" as="script"><link rel="prefetch" href="/assets/vidstack-BTBUzdbF-Cao5mZMB.js" as="script"><link rel="prefetch" href="/assets/vidstack-youtube-C-Qx_YwP.js" as="script"><link rel="prefetch" href="/assets/vidstack-DscYSLiW-CA6XwpqT.js" as="script"><link rel="prefetch" href="/assets/vidstack-54Jpr2Lq-D7xTX0W_.js" as="script"><link rel="prefetch" href="/assets/prod-DxPZqpt5.js" as="script"><link rel="prefetch" href="/assets/prod-DxPZqpt5.js" as="script"><link rel="prefetch" href="/assets/vidstack-BP-l85ST-Br_Q3bYe.js" as="script"><link rel="prefetch" href="/assets/vidstack-player-default-layout-C1YejbOb.js" as="script"><link rel="prefetch" href="/assets/vidstack-player-ui-BLk2T6qT.js" as="script"><link rel="prefetch" href="/assets/vidstack-CyVF_YzU-BKujtnaF.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-GXRgw7eJ.js" as="script"><link rel="prefetch" href="/assets/SearchResult-BLjEpg1X.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/"><img class="vp-nav-logo" src="/img/top.png" alt><!----><span class="vp-site-name hide-in-pad">Home Blog</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/" aria-label="é¦–é¡µ"><!---->é¦–é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/article/audio/Music.html" aria-label="Music"><!---->Music<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/article/video/Video.html" aria-label="Video"><!---->Video<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/article/cloudflare/" aria-label="Cloudflare"><!---->Cloudflare<!----></a></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/article/com408/" aria-label="è®¡ç®—æœºæ·±å…¥"><!---->è®¡ç®—æœºæ·±å…¥<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Java"><!--[--><!---->Java<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/basic/" aria-label="JavaåŸºç¡€"><!---->JavaåŸºç¡€<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/spring/" aria-label="Springç”Ÿæ€"><!---->Springç”Ÿæ€<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/datasource/" aria-label="æ•°æ®åŠæ¡†æ¶"><!---->æ•°æ®åŠæ¡†æ¶<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/%E4%B8%AD%E9%97%B4%E4%BB%B6/" aria-label="ä¸­é—´ä»¶"><!---->ä¸­é—´ä»¶<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/utils/utilClass.html" aria-label="ClassUtils"><!---->ClassUtils<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="é¡¹ç›®æ€»ç»“"><!--[--><!---->é¡¹ç›®æ€»ç»“<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/article/java/project/Rpc.html" aria-label="Rpcç¤ºä¾‹"><!---->Rpcç¤ºä¾‹<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/article/java/project/ORM.html" aria-label="ORMç¤ºä¾‹"><!---->ORMç¤ºä¾‹<!----></a></li></ul></button></div></div></nav><!--[--><button type="button" class="search-pro-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon" name="search"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!----><!----><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-color-mode-switch" id="color-mode-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" name="auto" style="display:none;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" name="dark" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" name="light" style="display:block;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><!----><span class="vp-sidebar-title">é¡¹ç›®</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link vp-sidebar-page active" href="/article/java/project/Rpc.html" aria-label="Rpcç¤ºä¾‹"><!---->Rpcç¤ºä¾‹<!----></a></li><li><a class="route-link auto-link vp-sidebar-link vp-sidebar-page" href="/article/java/project/ORM.html" aria-label="ORMç¤ºä¾‹"><!---->ORMç¤ºä¾‹<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->MyRPCFromZero</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-01-06T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 30 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT30M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color1 clickable" role="navigation">Project</span><span class="page-category-item color2 clickable" role="navigation">SpringBoot</span><!--]--><meta property="articleSection" content="Project,SpringBoot"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color7 clickable" role="navigation">RPC</span><span class="page-tag-item color8 clickable" role="navigation">é€šä¿¡</span><!--]--><meta property="keywords" content="RPC,é€šä¿¡"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#rpcçš„æ¦‚å¿µ">RPCçš„æ¦‚å¿µ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹">ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ç›®å½•">ç›®å½•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_0-ä¸€ä¸ªæœ€ç®€å•çš„rpcè°ƒç”¨">0.ä¸€ä¸ªæœ€ç®€å•çš„RPCè°ƒç”¨</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_1-myrpcç‰ˆæœ¬1">1.MyRPCç‰ˆæœ¬1</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_2-myrpc-ç‰ˆæœ¬2">2.MyRPC ç‰ˆæœ¬2</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_3-myrpcç‰ˆæœ¬3">3.MyRPCç‰ˆæœ¬3</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_4-myrpcç‰ˆæœ¬4">4.MyRPCç‰ˆæœ¬4</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_5-myrpcç‰ˆæœ¬5">5.MyRPCç‰ˆæœ¬5</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#_6-myrpcç‰ˆæœ¬6">6.MyRPCç‰ˆæœ¬6</a></li><!----><!--]--></ul></li><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h1 id="myrpcfromzero" tabindex="-1"><a class="header-anchor" href="#myrpcfromzero"><span>MyRPCFromZero</span></a></h1><p>ä»é›¶å¼€å§‹ï¼Œæ‰‹å†™ä¸€ä¸ªRPCï¼Œè·Ÿéšç€è¿™ç¯‡æ–‡æ¡£ä»¥åŠæ•°ä¸ªè¿­ä»£ç‰ˆæœ¬çš„ä»£ç ï¼Œç”±ç®€é™‹åˆ°é€æ¸å®Œå¤‡ï¼Œè®©æ‰€æœ‰äººéƒ½èƒ½çœ‹æ‡‚å¹¶ä¸”å†™å‡ºä¸€ä¸ªRPCæ¡†æ¶ã€‚</p><p>æœ¬æ–‡æ¡£ä¸ä»£ç éƒ½æ˜¯æœ¬äººç¬¬ä¸€æ¬¡æ‰‹å†™RPCçš„å¿ƒè·¯å†ç¨‹ï¼Œä¼šæœ‰ç†è§£çš„åå·®ä¸ä»£ç ä¸Šçš„ä¸å®Œå–„ï¼Œä½†æ›´æ˜¯ç”±äºè¿™æ ·ï¼Œæœ‰ç€ä¸æ–°æ‰‹å¯¹åŒæ ·é—®é¢˜çš„ç–‘æƒ‘ï¼Œä¹Ÿè®¸ä¼šä½¿æ–°æ‰‹æ›´å®¹æ˜“ç†è§£è¿™æ ·åšçš„ç¼˜æ•…æ˜¯å•¥ã€‚</p><p>å¦å¤–æœŸå¾…ä¸ä½ çš„<strong>åˆä½œ</strong>ï¼šä»£ç ï¼Œå¸®åŠ©æ–‡æ¡£ç”šè‡³rpcæ¡†æ¶åŠŸèƒ½çš„å®Œå¤‡</p><p><strong>å­¦ä¹ å»ºè®®</strong>ï¼š</p><ul><li>ä¸€å®šè¦å®é™…ä¸Šæ‰‹æ•²ä»£ç </li><li>æ¯ä¸€ç‰ˆæœ¬éƒ½æœ‰ç€å¯¹åº”ç‹¬ç«‹çš„ä»£ç ä¸æ–‡æ¡£ï¼Œç»“åˆæ¥çœ‹</li><li>æ¯ä¸€ç‰ˆæœ¬å‰æœ‰ä¸€ä¸ªèƒŒæ™¯çŸ¥è¯†ï¼Œå»ºè®®å…ˆæŒæ¡å…¶ç›¸å…³æ¦‚å¿µå†ä¸Šæ‰‹ä»£ç </li><li>æ¯ä¸€ä¸ªç‰ˆæœ¬éƒ½æœ‰ç€è¦è§£å†³çš„é—®é¢˜ä¸æ­¤ç‰ˆæœ¬çš„æœ€å¤§ç—›ç‚¹ï¼Œå¸¦ç€é—®é¢˜å»å†™ä»£ç ï¼Œå¹¶ä¸”ä¸ä¸Šä¸ªç‰ˆæœ¬çš„ä»£ç è¿›è¡Œæ¯”è¾ƒå·®å¼‚</li></ul><h2 id="rpcçš„æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#rpcçš„æ¦‚å¿µ"><span>RPCçš„æ¦‚å¿µ</span></a></h2><h4 id="èƒŒæ™¯çŸ¥è¯†" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>RPCçš„åŸºæœ¬æ¦‚å¿µï¼Œæ ¸å¿ƒåŠŸèƒ½</li></ul><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805124759206.png" alt="image-20200805001037799"></p><p>å¸¸è§çš„RPCæ¡†æ¶</p><h4 id="dubooåŸºæœ¬åŠŸèƒ½" tabindex="-1"><a class="header-anchor" href="#dubooåŸºæœ¬åŠŸèƒ½"><span>DubooåŸºæœ¬åŠŸèƒ½</span></a></h4><ol><li><strong>è¿œç¨‹é€šè®¯</strong></li><li>åŸºäºæ¥å£æ–¹æ³•çš„é€æ˜è¿œç¨‹è¿‡ç¨‹è°ƒç”¨</li><li>è´Ÿè½½å‡è¡¡</li><li>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</li></ol><h4 id="rpcè¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#rpcè¿‡ç¨‹"><span>RPCè¿‡ç¨‹</span></a></h4><p>client è°ƒç”¨è¿œç¨‹æ–¹æ³•-&gt; requeståºåˆ—åŒ– -&gt; åè®®ç¼–ç  -&gt; ç½‘ç»œä¼ è¾“-&gt; æœåŠ¡ç«¯ -&gt; ååºåˆ—åŒ–request -&gt; è°ƒç”¨æœ¬åœ°æ–¹æ³•å¾—åˆ°response -&gt; åºåˆ—åŒ– -&gt;ç¼–ç -&gt;â€¦..</p><hr><h2 id="ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹"><span>ç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹</span></a></h2><h3 id="ç›®å½•" tabindex="-1"><a class="header-anchor" href="#ç›®å½•"><span>ç›®å½•</span></a></h3><p>ä»0å¼€å§‹çš„RPCçš„è¿­ä»£è¿‡ç¨‹ï¼š</p><ul><li><a href="#0.%E4%B8%80%E4%B8%AA%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84RPC%E8%B0%83%E7%94%A8">version0ç‰ˆæœ¬</a>ï¼šä»¥ä¸åˆ°ç™¾è¡Œçš„ä»£ç å®Œæˆä¸€ä¸ªRPCä¾‹å­</li><li><a href="#1.MyRPC%E7%89%88%E6%9C%AC1">version1ç‰ˆæœ¬</a>ï¼šå®Œå–„é€šç”¨æ¶ˆæ¯æ ¼å¼ï¼ˆrequestï¼Œresponseï¼‰ï¼Œå®¢æˆ·ç«¯çš„åŠ¨æ€ä»£ç†å®Œæˆå¯¹requestæ¶ˆæ¯æ ¼å¼çš„å°è£…</li><li><a href="#2.MyRPC%E7%89%88%E6%9C%AC2">version2ç‰ˆæœ¬</a>ï¼šæ”¯æŒæœåŠ¡ç«¯æš´éœ²å¤šä¸ªæœåŠ¡æ¥å£ï¼Œ æœåŠ¡ç«¯ç¨‹åºæŠ½è±¡åŒ–ï¼Œè§„èŒƒåŒ–</li><li><a href="#3.MyRPC%E7%89%88%E6%9C%AC3">version3ç‰ˆæœ¬</a>ï¼šä½¿ç”¨é«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶nettyçš„å®ç°ç½‘ç»œé€šä¿¡ï¼Œä»¥åŠå®¢æˆ·ç«¯ä»£ç çš„é‡æ„</li><li><a href="#4.MyRPC%E7%89%88%E6%9C%AC4">version4ç‰ˆæœ¬</a>ï¼šè‡ªå®šä¹‰æ¶ˆæ¯æ ¼å¼ï¼Œæ”¯æŒå¤šç§åºåˆ—åŒ–æ–¹å¼ï¼ˆjavaåŸç”Ÿï¼Œ jsonâ€¦ï¼‰</li><li><a href="#5.MyRPC%E7%89%88%E6%9C%AC5">version5ç‰ˆæœ¬</a>: æœåŠ¡å™¨æ³¨å†Œä¸å‘ç°çš„å®ç°ï¼Œzookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒ</li><li><a href="#MyRPC%E7%89%88%E6%9C%AC6">version6ç‰ˆæœ¬</a>: è´Ÿè½½å‡è¡¡çš„ç­–ç•¥çš„å®ç°</li><li><a href="#7.MyRPC%E7%89%88%E6%9C%AC7">version7ç‰ˆæœ¬</a>: å®¢æˆ·ç«¯ç¼“å­˜æœåŠ¡åœ°å€åˆ—è¡¨, zookeeperç›‘å¬æœåŠ¡æä¾›è€…çŠ¶æ€ï¼Œæ›´æ–°å®¢æˆ·ç«¯ç¼“å­˜**ï¼ˆå¾…å®ç°ï¼‰**</li><li><a href="#8.MyRPC%E7%89%88%E6%9C%AC8">version8ç‰ˆæœ¬</a>ï¼š è·¨è¯­è¨€çš„RPCé€šä¿¡ï¼ˆprotobufï¼‰<strong>ï¼ˆå¾…å®ç°ï¼‰</strong></li></ul><hr><h3 id="_0-ä¸€ä¸ªæœ€ç®€å•çš„rpcè°ƒç”¨" tabindex="-1"><a class="header-anchor" href="#_0-ä¸€ä¸ªæœ€ç®€å•çš„rpcè°ƒç”¨"><span>0.ä¸€ä¸ªæœ€ç®€å•çš„RPCè°ƒç”¨</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-1" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-1"><span><strong>èƒŒæ™¯çŸ¥è¯†</strong></span></a></h4><ul><li>javaåŸºç¡€</li><li>java socketç¼–ç¨‹å…¥é—¨</li><li>é¡¹ç›®ä½¿ç”¨mavenæ­å»ºï¼Œæš‚æ—¶åªå¼•å…¥äº†lombokåŒ…</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><ul><li><strong>ä»€ä¹ˆæ˜¯RPCï¼Œæ€ä¹ˆå®Œæˆä¸€ä¸ªRPC?</strong></li></ul><p>ä¸€ä¸ªRPC<strong>æœ€æœ€æœ€ç®€å•</strong>çš„è¿‡ç¨‹æ˜¯å®¢æˆ·ç«¯<strong>è°ƒç”¨</strong>æœåŠ¡ç«¯çš„çš„ä¸€ä¸ªæ–¹æ³•, æœåŠ¡ç«¯è¿”å›æ‰§è¡Œæ–¹æ³•çš„è¿”å›å€¼ç»™å®¢æœç«¯ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šä»¥ä¸€ä¸ªä»æ•°æ®åº“é‡Œå–æ•°æ®çš„ä¾‹å­æ¥è¿›è¡Œä¸€æ¬¡æ¨¡æ‹ŸRPCè¿‡ç¨‹çš„ä¸€ä¸ªå®Œæ•´æµç¨‹ã€‚</p><p><strong>å‡å®š</strong>æœ‰ä»¥ä¸‹è¿™æ ·ä¸€ä¸ªæœåŠ¡ï¼š</p><p>æœåŠ¡ç«¯ï¼š</p><ol><li><p>æœ‰ä¸€ä¸ªUserè¡¨</p><ol start="2"><li>UserServiceImpl å®ç°äº†UserServiceæ¥å£</li><li>UserServiceé‡Œæš‚æ—¶åªæœ‰ä¸€ä¸ªåŠŸèƒ½: getUserByUserId(Integer id)</li></ol></li></ol><p>å®¢æˆ·ç«¯ï¼š</p><p>â€‹ ä¼ ä¸€ä¸ªIdç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æŸ¥è¯¢åˆ°Userå¯¹è±¡è¿”å›ç»™å®¢æˆ·ç«¯</p><h4 id="è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#è¿‡ç¨‹"><span>è¿‡ç¨‹</span></a></h4><ol><li>é¦–å…ˆæˆ‘ä»¬å¾—æœ‰Userå¯¹è±¡ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯éƒ½å·²çŸ¥çš„ï¼Œå®¢æˆ·ç«¯éœ€è¦å¾—åˆ°è¿™ä¸ªpojoå¯¹è±¡æ•°æ®ï¼ŒæœåŠ¡ç«¯éœ€è¦æ“ä½œè¿™ä¸ªå¯¹è±¡</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@Builder</span></span>
<span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token annotation punctuation">@NoArgsConstructor</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±æœ‰çš„</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> userName<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> sex<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>å®šä¹‰å®¢æˆ·ç«¯éœ€è¦è°ƒç”¨ï¼ŒæœåŠ¡ç«¯éœ€è¦æä¾›çš„æœåŠ¡æ¥å£</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªæ¥å£è°ƒç”¨æœåŠ¡ç«¯çš„å®ç°ç±»</span></span>
<span class="line">    <span class="token class-name">User</span> <span class="token function">getUserByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>æœåŠ¡ç«¯éœ€è¦å®ç°Serviceæ¥å£çš„åŠŸèƒ½</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">getUserByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯æŸ¥è¯¢äº†&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot;çš„ç”¨æˆ·&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­å–ç”¨æˆ·çš„è¡Œä¸º</span></span>
<span class="line">        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">sex</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> user<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>å®¢æˆ·ç«¯å»ºç«‹Socketè¿æ¥ï¼Œä¼ è¾“Idç»™æœåŠ¡ç«¯ï¼Œå¾—åˆ°è¿”å›çš„Userå¯¹è±¡</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å»ºç«‹Socketè¿æ¥</span></span>
<span class="line">            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// ä¼ ç»™æœåŠ¡å™¨id</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// æœåŠ¡å™¨æŸ¥è¯¢æ•°æ®ï¼Œè¿”å›å¯¹åº”çš„å¯¹è±¡</span></span>
<span class="line">            <span class="token class-name">User</span> user  <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯è¿”å›çš„User:&quot;</span><span class="token operator">+</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯å¯åŠ¨å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="5"><li>æœåŠ¡ç«¯ä»¥BIOçš„æ–¹å¼ç›‘å¬Socketï¼Œå¦‚æœ‰æ•°æ®ï¼Œè°ƒç”¨å¯¹åº”æœåŠ¡çš„å®ç°ç±»æ‰§è¡Œä»»åŠ¡ï¼Œå°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserServiceImpl</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯å¯åŠ¨äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// BIOçš„æ–¹å¼ç›‘å¬Socket</span></span>
<span class="line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// è¯»å–å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„id</span></span>
<span class="line">                        <span class="token class-name">Integer</span> id <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">User</span> userByUserId <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserByUserId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// å†™å…¥Userå¯¹è±¡ç»™å®¢æˆ·ç«¯</span></span>
<span class="line">                        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>userByUserId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        oos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»IOä¸­è¯»å–æ•°æ®é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¯åŠ¨å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ" tabindex="-1"><a class="header-anchor" href="#ç»“æœ"><span>ç»“æœï¼š</span></a></h4><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805001024797.png" alt="image-20200805001024797"></p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805001037799.png" alt="image-20200805124759206"></p><h4 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“ï¼š</span></a></h4><p>è¿™ä¸ªä¾‹å­ä»¥ä¸åˆ°ç™¾è¡Œçš„ä»£ç ï¼Œå®ç°äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„ä¸€ä¸ªè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œéå¸¸é€‚åˆä¸Šæ‰‹ï¼Œå½“ç„¶å®ƒæ˜¯<strong>åŠå…¶ä¸å®Œå–„</strong>çš„ï¼Œç”šè‡³è¿æ¶ˆæ¯æ ¼å¼éƒ½æ²¡æœ‰ç»Ÿä¸€ï¼Œæˆ‘ä»¬å°†åœ¨æ¥ä¸‹æ¥çš„ç‰ˆæœ¬æ›´æ–°ä¸­é€æ¸å®Œå–„å®ƒã€‚</p><h4 id="æ­¤rpcçš„æœ€å¤§ç—›ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ­¤rpcçš„æœ€å¤§ç—›ç‚¹"><span>æ­¤RPCçš„æœ€å¤§ç—›ç‚¹ï¼š</span></a></h4><ol><li>åªèƒ½è°ƒç”¨æœåŠ¡ç«¯Serviceå”¯ä¸€ç¡®å®šçš„æ–¹æ³•ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦è°ƒç”¨å‘¢?ï¼ˆReuestéœ€è¦æŠ½è±¡ï¼‰</li><li>è¿”å›å€¼åªæ”¯æŒUserå¯¹è±¡ï¼Œå¦‚æœéœ€è¦ä¼ ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…ä¸€ä¸ªDogï¼ŒStringå¯¹è±¡å‘¢ï¼ˆResponseéœ€è¦æŠ½è±¡ï¼‰</li><li>å®¢æˆ·ç«¯ä¸å¤Ÿé€šç”¨ï¼Œhostï¼Œportï¼Œ ä¸è°ƒç”¨çš„æ–¹æ³•éƒ½ç‰¹å®šï¼ˆéœ€è¦æŠ½è±¡ï¼‰</li></ol><hr><h3 id="_1-myrpcç‰ˆæœ¬1" tabindex="-1"><a class="header-anchor" href="#_1-myrpcç‰ˆæœ¬1"><span>1.MyRPCç‰ˆæœ¬1</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-2" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-2"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>åå°„</li><li>åŠ¨æ€ä»£ç†</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-1" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-1"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><ul><li><p>å¦‚ä½•ä½¿å®¢æˆ·ç«¯è¯·æ±‚è¿œç¨‹æ–¹æ³•æ”¯æŒå¤šç§?</p></li><li><p>å¦‚ä½•ä½¿æœåŠ¡ç«¯è¿”å›å€¼çš„ç±»å‹å¤šæ ·?</p></li></ul><h4 id="ç‰ˆæœ¬å‡çº§è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#ç‰ˆæœ¬å‡çº§è¿‡ç¨‹"><span>ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</span></a></h4><p><strong>æ›´æ–°1</strong>ï¼šå®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„Requestçš„å¯¹è±¡ï¼ˆæ¶ˆæ¯æ ¼å¼ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * åœ¨ä¸Šä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„Requestä»…ä»…åªå‘é€äº†ä¸€ä¸ªidå‚æ•°è¿‡å»ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼Œ</span>
<span class="line"> * å› ä¸ºæœåŠ¡ç«¯ä¸ä¼šåªæœ‰ä¸€ä¸ªæœåŠ¡ä¸€ä¸ªæ–¹æ³•ï¼Œå› æ­¤åªä¼ é€’å‚æ•°ä¸ä¼šçŸ¥é“è°ƒç”¨é‚£ä¸ªæ–¹æ³•</span>
<span class="line"> * å› æ­¤ä¸€ä¸ªRPCè¯·æ±‚ä¸­ï¼Œclientå‘é€åº”è¯¥æ˜¯éœ€è¦è°ƒç”¨çš„Serviceæ¥å£åï¼Œæ–¹æ³•åï¼Œå‚æ•°ï¼Œå‚æ•°ç±»å‹</span>
<span class="line"> * è¿™æ ·æœåŠ¡ç«¯å°±èƒ½æ ¹æ®è¿™äº›ä¿¡æ¯æ ¹æ®åå°„è°ƒç”¨ç›¸åº”çš„æ–¹æ³•</span>
<span class="line"> * è¿˜æ˜¯ä½¿ç”¨javaè‡ªå¸¦çš„åºåˆ—åŒ–æ–¹å¼</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token annotation punctuation">@Builder</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCRequest</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æœåŠ¡ç±»åï¼Œå®¢æˆ·ç«¯åªçŸ¥é“æ¥å£åï¼Œåœ¨æœåŠ¡ç«¯ä¸­ç”¨æ¥å£åæŒ‡å‘å®ç°ç±»</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> interfaceName<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// æ–¹æ³•å</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> methodName<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// å‚æ•°åˆ—è¡¨</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// å‚æ•°ç±»å‹</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramsTypes<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°2ï¼š</strong> å®šä¹‰äº†ä¸€ä¸ªé€šç”¨çš„Responseçš„å¯¹è±¡ï¼ˆæ¶ˆæ¯æ ¼å¼ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * ä¸Šä¸ªä¾‹å­ä¸­responseä¼ è¾“çš„æ˜¯Userå¯¹è±¡ï¼Œæ˜¾ç„¶åœ¨ä¸€ä¸ªåº”ç”¨ä¸­æˆ‘ä»¬ä¸å¯èƒ½åªä¼ è¾“ä¸€ç§ç±»å‹çš„æ•°æ®</span>
<span class="line"> * ç”±æ­¤æˆ‘ä»¬å°†ä¼ è¾“å¯¹è±¡æŠ½è±¡æˆä¸ºObject</span>
<span class="line"> * Rpcéœ€è¦ç»è¿‡ç½‘ç»œä¼ è¾“ï¼Œæœ‰å¯èƒ½å¤±è´¥ï¼Œç±»ä¼¼äºhttpï¼Œå¼•å…¥çŠ¶æ€ç å’ŒçŠ¶æ€ä¿¡æ¯è¡¨ç¤ºæœåŠ¡è°ƒç”¨æˆåŠŸè¿˜æ˜¯å¤±è´¥</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token annotation punctuation">@Builder</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCResponse</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// çŠ¶æ€ä¿¡æ¯</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> code<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// å…·ä½“æ•°æ®</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RPCResponse</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token class-name">Object</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RPCResponse</span> <span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å› æ­¤åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹éƒ½æ˜¯requestä¸responseæ ¼å¼çš„æ•°æ®äº†ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯å°±è¦è´Ÿè´£å°è£…ä¸è§£æä»¥ä¸Šç»“æ„æ•°æ®</p><p><strong>æ›´æ–°3ï¼š</strong> æœåŠ¡ç«¯æ¥å—requestè¯·æ±‚ï¼Œå¹¶è°ƒç”¨requestä¸­çš„å¯¹åº”çš„æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªæ¥å£è°ƒç”¨æœåŠ¡ç«¯çš„å®ç°ç±»</span></span>
<span class="line">    <span class="token class-name">User</span> <span class="token function">getUserByUserId</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ç»™è¿™ä¸ªæœåŠ¡å¢åŠ ä¸€ä¸ªåŠŸèƒ½</span></span>
<span class="line">    <span class="token class-name">Integer</span> <span class="token function">insertUserId</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡ç«¯çš„å®ç°ç±»UserServiceImplè¦å®ç°å¢åŠ çš„åŠŸèƒ½</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">insertUserId</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ’å…¥æ•°æ®æˆåŠŸï¼š&quot;</span><span class="token operator">+</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡ç«¯æ¥å—è§£æreuqestä¸å°è£…å‘é€responseå¯¹è±¡</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">UserServiceImpl</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span><span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯å¯åŠ¨äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// BIOçš„æ–¹å¼ç›‘å¬Socket</span></span>
<span class="line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼Œè¿™ä¸ªç±»è´Ÿè´£çš„åŠŸèƒ½å¤ªå¤æ‚ï¼Œä»¥åä»£ç é‡æ„ä¸­ï¼Œè¿™éƒ¨åˆ†åŠŸèƒ½è¦åˆ†ç¦»å‡ºæ¥</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// è¯»å–å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„request</span></span>
<span class="line">                        <span class="token class-name">RPCRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RPCRequest</span><span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// åå°„è°ƒç”¨å¯¹åº”æ–¹æ³•</span></span>
<span class="line">                        <span class="token class-name">Method</span> method <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">Object</span> invoke <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>userService<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token comment">// å°è£…ï¼Œå†™å…¥responseå¯¹è±¡</span></span>
<span class="line">                        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span><span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>invoke<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        oos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> <span class="token operator">|</span> <span class="token class-name">NoSuchMethodException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»IOä¸­è¯»å–æ•°æ®é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line">                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¯åŠ¨å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°4ï¼š</strong> å®¢æˆ·ç«¯æ ¹æ®ä¸åŒçš„Serviceè¿›è¡ŒåŠ¨æ€ä»£ç†ï¼š</p><p>ä»£ç†å¯¹è±¡å¢å¼ºçš„<strong>å…¬å…±è¡Œä¸º</strong>ï¼šæŠŠä¸åŒçš„Serviceæ–¹æ³•<strong>å°è£…æˆç»Ÿä¸€çš„Requestå¯¹è±¡æ ¼å¼</strong>ï¼Œå¹¶ä¸”å»ºç«‹ä¸Serverçš„é€šä¿¡</p><ol><li>åº•å±‚çš„é€šä¿¡</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IOClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// è¿™é‡Œè´Ÿè´£åº•å±‚ä¸æœåŠ¡ç«¯çš„é€šä¿¡ï¼Œå‘é€çš„Requestï¼Œæ¥å—çš„æ˜¯Responseå¯¹è±¡</span></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚è°ƒç”¨ï¼ŒSocketå»ºç«‹è¿æ¥ï¼Œå‘èµ·è¯·æ±‚Requestï¼Œå¾—åˆ°å“åº”Response</span></span>
<span class="line">    <span class="token comment">// è¿™é‡Œçš„requestæ˜¯å°è£…å¥½çš„ï¼ˆä¸Šå±‚è¿›è¡Œå°è£…ï¼‰ï¼Œä¸åŒçš„serviceéœ€è¦è¿›è¡Œä¸åŒçš„å°è£…ï¼Œ å®¢æˆ·ç«¯åªçŸ¥é“Serviceæ¥å£ï¼Œéœ€è¦ä¸€å±‚åŠ¨æ€ä»£ç†æ ¹æ®åå°„å°è£…ä¸åŒçš„Service</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">RPCResponse</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RPCResponse</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>åŠ¨æ€ä»£ç†å°è£…requestå¯¹è±¡</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClientProxy</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// ä¼ å…¥å‚æ•°Serviceæ¥å£çš„classå¯¹è±¡ï¼Œåå°„å°è£…æˆä¸€ä¸ªrequest</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// jdk åŠ¨æ€ä»£ç†ï¼Œ æ¯ä¸€æ¬¡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œä¼šç»è¿‡æ­¤æ–¹æ³•å¢å¼ºï¼ˆåå°„è·å–requestå¯¹è±¡ï¼Œsocketå‘é€è‡³å®¢æˆ·ç«¯ï¼‰</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> proxy<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// requestçš„æ„å»ºï¼Œä½¿ç”¨äº†lombokä¸­çš„builderï¼Œä»£ç ç®€æ´</span></span>
<span class="line">        <span class="token class-name">RPCRequest</span> request <span class="token operator">=</span> <span class="token class-name">RPCRequest</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interfaceName</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">methodName</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">params</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">paramsTypes</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ•°æ®ä¼ è¾“</span></span>
<span class="line">        <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token class-name">IOClient</span><span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">//System.out.println(response);</span></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token class-name">T</span> <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>clazz<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>å®¢æˆ·ç«¯è°ƒç”¨ä¸åŒçš„æ–¹æ³•</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RPCClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">ClientProxy</span> clientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientProxy</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">UserService</span> proxy <span class="token operator">=</span> clientProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// æœåŠ¡çš„æ–¹æ³•1</span></span>
<span class="line">        <span class="token class-name">User</span> userByUserId <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">getUserByUserId</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»æœåŠ¡ç«¯å¾—åˆ°çš„userä¸ºï¼š&quot;</span> <span class="token operator">+</span> userByUserId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æœåŠ¡çš„æ–¹æ³•2</span></span>
<span class="line">        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">userName</span><span class="token punctuation">(</span><span class="token string">&quot;å¼ ä¸‰&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sex</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Integer</span> integer <span class="token operator">=</span> proxy<span class="token punctuation">.</span><span class="token function">insertUserId</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å‘æœåŠ¡ç«¯æ’å…¥æ•°æ®ï¼š&quot;</span><span class="token operator">+</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ-1" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-1"><span>ç»“æœ</span></a></h4><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805163937195.png" alt="image-20200805163937195"></p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805163959630.png" alt="image-20200805163959630"></p><h4 id="æ€»ç»“-1" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-1"><span>æ€»ç»“</span></a></h4><ol><li>å®šä¹‰æ›´åŠ é€šç”¨çš„æ¶ˆæ¯æ ¼å¼ï¼šRequest ä¸Responseæ ¼å¼ï¼Œ ä»æ­¤å¯èƒ½è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¸è¿”å›å„ç§ç±»å‹çš„æ•°æ®ã€‚</li><li>ä½¿ç”¨äº†åŠ¨æ€ä»£ç†è¿›è¡Œä¸åŒæœåŠ¡æ–¹æ³•çš„Requestçš„å°è£…ï¼Œ</li><li>å®¢æˆ·ç«¯æ›´åŠ æ¾è€¦åˆï¼Œä¸å†ä¸ç‰¹å®šçš„Serviceï¼Œhostï¼Œportç»‘å®š</li></ol><h4 id="å­˜åœ¨çš„ç—›ç‚¹" tabindex="-1"><a class="header-anchor" href="#å­˜åœ¨çš„ç—›ç‚¹"><span>å­˜åœ¨çš„ç—›ç‚¹</span></a></h4><ol><li>æœåŠ¡ç«¯æˆ‘ä»¬ç›´æ¥ç»‘å®šçš„æ˜¯UserServiceæœåŠ¡ï¼Œå¦‚æœè¿˜æœ‰å…¶å®ƒæœåŠ¡æ¥å£æš´éœ²å‘¢?ï¼ˆå¤šä¸ªæœåŠ¡çš„æ³¨å†Œï¼‰</li><li>æœåŠ¡ç«¯ä»¥BIOçš„æ–¹å¼æ€§èƒ½æ˜¯å¦å¤ªä½ï¼Œ</li><li>æœåŠ¡ç«¯åŠŸèƒ½å¤ªå¤æ‚ï¼šç›‘å¬ï¼Œå¤„ç†ã€‚éœ€è¦æ¾è€¦åˆ</li></ol><hr><h3 id="_2-myrpc-ç‰ˆæœ¬2" tabindex="-1"><a class="header-anchor" href="#_2-myrpc-ç‰ˆæœ¬2"><span>2.MyRPC ç‰ˆæœ¬2</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-3" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-3"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>ä»£ç è§£è€¦</li><li>çº¿ç¨‹æ± </li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-2" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-2"><span>æœ¬èŠ‚é—®é¢˜ï¼š</span></a></h4><p>å¦‚æœä¸€ä¸ªæœåŠ¡ç«¯è¦æä¾›å¤šä¸ªæœåŠ¡çš„æ¥å£ï¼Œ ä¾‹å¦‚æ–°å¢ä¸€ä¸ªBlogServiceï¼Œæ€ä¹ˆå¤„ç†?</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// è‡ªç„¶çš„æƒ³åˆ°ç”¨ä¸€ä¸ªMapæ¥ä¿å­˜ï¼Œ&lt;interfaceName, xxxServiceImpl&gt;</span></span>
<span class="line"><span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">BlogService</span> blogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlogServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;***.userService&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;***.blogService&quot;</span><span class="token punctuation">,</span> blogService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// æ­¤æ—¶æ¥äº†ä¸€ä¸ªrequestï¼Œæˆ‘ä»¬å°±èƒ½ä»mapä¸­å–å‡ºå¯¹åº”çš„æœåŠ¡</span></span>
<span class="line"><span class="token class-name">Object</span> service <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç‰ˆæœ¬å‡çº§è¿‡ç¨‹-1" tabindex="-1"><a class="header-anchor" href="#ç‰ˆæœ¬å‡çº§è¿‡ç¨‹-1"><span>ç‰ˆæœ¬å‡çº§è¿‡ç¨‹</span></a></h4><p><strong>æ›´æ–°å‰çš„å·¥ä½œï¼š</strong> æ›´æ–°ä¸€ä¸ªæ–°çš„æœåŠ¡æ¥å£æ ·ä¾‹å’Œpojoç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// æ–°çš„æœåŠ¡æ¥å£</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlogService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Blog</span> <span class="token function">getBlogById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// æœåŠ¡ç«¯æ–°çš„æœåŠ¡æ¥å£å®ç°ç±»</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlogServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">BlogService</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Blog</span> <span class="token function">getBlogById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Blog</span> blog <span class="token operator">=</span> <span class="token class-name">Blog</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘çš„åšå®¢&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useId</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å®¢æˆ·ç«¯æŸ¥è¯¢äº†&quot;</span><span class="token operator">+</span>id<span class="token operator">+</span><span class="token string">&quot;åšå®¢&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> blog<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// pojoç±»</span></span>
<span class="line"><span class="token annotation punctuation">@Data</span></span>
<span class="line"><span class="token annotation punctuation">@Builder</span></span>
<span class="line"><span class="token annotation punctuation">@NoArgsConstructor</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Blog</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> id<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Integer</span> useId<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°1ï¼š</strong> HashMap&lt;String, Object&gt; æ·»åŠ å¤šä¸ªæœåŠ¡çš„å®ç°ç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">BlogService</span> blogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlogServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æš´éœ²ä¸¤ä¸ªæœåŠ¡æ¥å£ï¼Œ å³åœ¨RPCServerä¸­åŠ ä¸€ä¸ªHashMap</span></span>
<span class="line">        serviceProvide<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;com.ganghuan.myRPCVersion2.service.UserService&quot;</span><span class="token punctuation">,</span>userService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        serviceProvide<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;com.ganghuan.myRPCVersion2.service.BlogService&quot;</span><span class="token punctuation">,</span>blogService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">RPCServer</span> <span class="token class-name">RPCServer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRPCRPCServer</span><span class="token punctuation">(</span>serviceProvide<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">RPCServer</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// è¿™é‡Œå…ˆä¸å»è®¨è®ºå®ç°å…¶ä¸­çš„ç»†èŠ‚ï¼Œå› ä¸ºè¿™é‡Œè¿˜åº”è¯¥è¿›è¡Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å…ˆå»æŠŠæœåŠ¡ç«¯ä»£ç æ¾è€¦åˆï¼Œå†å›è¿‡æ¥è®¨è®º</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°2ï¼š</strong> æœåŠ¡ç«¯ä»£ç é‡æ„</p><ol><li>æŠ½è±¡RPCServerï¼Œå¼€æ”¾å°é—­åŸåˆ™</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// æŠŠRPCServeræŠ½è±¡æˆæ¥å£ï¼Œä»¥åçš„æœåŠ¡ç«¯å®ç°è¿™ä¸ªæ¥å£å³å¯</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>RPCServiceç®€å•ç‰ˆæœ¬çš„å®ç°</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * è¿™ä¸ªå®ç°ç±»ä»£è¡¨ç€javaåŸå§‹çš„BIOç›‘å¬æ¨¡å¼ï¼Œæ¥ä¸€ä¸ªä»»åŠ¡ï¼Œå°±newä¸€ä¸ªçº¿ç¨‹å»å¤„ç†</span>
<span class="line"> * å¤„ç†ä»»åŠ¡çš„å·¥ä½œè§WorkThreadä¸­</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRPCRPCServer</span> <span class="token keyword">implements</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// å­˜ç€æœåŠ¡æ¥å£å-&gt; serviceå¯¹è±¡çš„map</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">SimpleRPCRPCServer</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceProvide <span class="token operator">=</span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯å¯åŠ¨äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// BIOçš„æ–¹å¼ç›‘å¬Socket</span></span>
<span class="line">            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹å»å¤„ç†</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WorkThread</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>serviceProvide<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å¯åŠ¨å¤±è´¥&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>ä¸ºäº†åŠ å¼ºæ€§èƒ½ï¼Œæˆ‘ä»¬è¿˜æä¾›äº†<strong>çº¿ç¨‹æ± ç‰ˆ</strong>çš„å®ç°</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolRPCRPCServer</span> <span class="token keyword">implements</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ThreadPoolExecutor</span> threadPool<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolRPCRPCServer</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceProvide <span class="token operator">=</span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ThreadPoolRPCRPCServer</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">,</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span></span>
<span class="line">                                  <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span></span>
<span class="line">                                  <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span></span>
<span class="line">                                  <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span></span>
<span class="line">                                  <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> workQueue<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        </span>
<span class="line">        threadPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>corePoolSize<span class="token punctuation">,</span> maximumPoolSize<span class="token punctuation">,</span> keepAliveTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> workQueue<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceProvide <span class="token operator">=</span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡ç«¯å¯åŠ¨äº†&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ServerSocket</span> serverSocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name">Socket</span> socket <span class="token operator">=</span> serverSocket<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                threadPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WorkThread</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span>serviceProvide<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>å·¥ä½œä»»åŠ¡ç±»ï¼Œä»æœåŠ¡ç«¯ä»£ç åˆ†ç¦»å‡ºæ¥ï¼Œç®€åŒ–æœåŠ¡ç«¯ä»£ç ï¼Œå•ä¸€èŒè´£åŸåˆ™</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * è¿™é‡Œè´Ÿè´£è§£æå¾—åˆ°çš„requestè¯·æ±‚ï¼Œæ‰§è¡ŒæœåŠ¡æ–¹æ³•ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯</span>
<span class="line"> * 1. ä»requestå¾—åˆ°interfaceName 2. æ ¹æ®interfaceNameåœ¨serviceProvide Mapä¸­è·å–æœåŠ¡ç«¯çš„å®ç°ç±»</span>
<span class="line"> * 3. ä»requestä¸­å¾—åˆ°æ–¹æ³•åï¼Œå‚æ•°ï¼Œ åˆ©ç”¨åå°„æ‰§è¡ŒæœåŠ¡ä¸­çš„æ–¹æ³• 4. å¾—åˆ°ç»“æœï¼Œå°è£…æˆresponseï¼Œå†™å…¥socket</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WorkThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Socket</span> socket<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> serviceProvide<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// è¯»å–å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„request</span></span>
<span class="line">            <span class="token class-name">RPCRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RPCRequest</span><span class="token punctuation">)</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// åå°„è°ƒç”¨æœåŠ¡æ–¹æ³•è·å¾—è¿”å›å€¼</span></span>
<span class="line">            <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token function">getResponse</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">//å†™å…¥åˆ°å®¢æˆ·ç«¯</span></span>
<span class="line">            oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            oos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»IOä¸­è¯»å–æ•°æ®é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">RPCResponse</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¾—åˆ°æœåŠ¡å</span></span>
<span class="line">        <span class="token class-name">String</span> interfaceName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å¾—åˆ°æœåŠ¡ç«¯ç›¸åº”æœåŠ¡å®ç°ç±»</span></span>
<span class="line">        <span class="token class-name">Object</span> service <span class="token operator">=</span> serviceProvide<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// åå°„è°ƒç”¨æ–¹æ³•</span></span>
<span class="line">        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            method <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Object</span> invoke <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>invoke<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•æ‰§è¡Œé”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡ç«¯ä»£ç ç¬¬ä¸€æ¬¡é‡æ„å®Œæ¯•ã€‚</p><p><strong>æ›´æ–°3ï¼š</strong> æœåŠ¡æš´éœ²ç±»ï¼Œè¿™é‡Œå›åˆ°äº†æ›´æ–°1**ï¼Œæˆ‘ä»¬å‘ç°æœåŠ¡æ¥å£åæ˜¯æˆ‘ä»¬**ç›´æ¥æ‰‹å†™çš„ï¼Œè¿™é‡Œå…¶å®å¯ä»¥åˆ©ç”¨classå¯¹è±¡è‡ªåŠ¨å¾—åˆ°</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * ä¹‹å‰è¿™é‡Œä½¿ç”¨Mapç®€å•å®ç°çš„</span>
<span class="line"> * å­˜æ”¾æœåŠ¡æ¥å£åä¸æœåŠ¡ç«¯å¯¹åº”çš„å®ç°ç±»</span>
<span class="line"> * æœåŠ¡å¯åŠ¨æ—¶è¦æš´éœ²å…¶ç›¸å…³çš„å®ç°ç±»0</span>
<span class="line"> * æ ¹æ®requestä¸­çš„interfaceè°ƒç”¨æœåŠ¡ç«¯ä¸­ç›¸å…³å®ç°ç±»</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProvider</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * ä¸€ä¸ªå®ç°ç±»å¯èƒ½å®ç°å¤šä¸ªæ¥å£</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> interfaceProvider<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>interfaceProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">provideServiceInterface</span><span class="token punctuation">(</span><span class="token class-name">Object</span> service<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz <span class="token operator">:</span> interfaces<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            interfaceProvider<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> interfaceName<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> interfaceProvider<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å‰é¢æœåŠ¡ç«¯çš„ä»£ç ä¸­æœ‰Sevicerprovide è¿™ä¸ªHashMapçš„åœ°æ–¹éœ€è¦æ”¹æˆServiProviderï¼Œæ¯”å¦‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">BlogService</span> blogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BlogServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">//        Map&lt;String, Object&gt; serviceProvide = new HashMap&lt;&gt;();</span></span>
<span class="line"><span class="token comment">//        serviceProvide.put(&quot;com.ganghuan.myRPCVersion2.service.UserService&quot;,userService);</span></span>
<span class="line"><span class="token comment">//        serviceProvide.put(&quot;com.ganghuan.myRPCVersion2.service.BlogService&quot;,blogService);</span></span>
<span class="line">        <span class="token class-name">ServiceProvider</span> serviceProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        serviceProvider<span class="token punctuation">.</span><span class="token function">provideServiceInterface</span><span class="token punctuation">(</span>userService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        serviceProvider<span class="token punctuation">.</span><span class="token function">provideServiceInterface</span><span class="token punctuation">(</span>blogService<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token class-name">RPCServer</span> <span class="token class-name">RPCServer</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRPCRPCServer</span><span class="token punctuation">(</span>serviceProvider<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">RPCServer</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ-2" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-2"><span>ç»“æœ</span></a></h4><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// å®¢æˆ·ä¸­æ·»åŠ æ–°çš„æµ‹è¯•ç”¨ä¾‹        </span></span>
<span class="line"><span class="token class-name">BlogService</span> blogService <span class="token operator">=</span> rpcClientProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">BlogService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">Blog</span> blogById <span class="token operator">=</span> blogService<span class="token punctuation">.</span><span class="token function">getBlogById</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;ä»æœåŠ¡ç«¯å¾—åˆ°çš„blogä¸ºï¼š&quot;</span> <span class="token operator">+</span> blogById<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200805221430990.png" alt="image-20200805221430990"></p><h4 id="æ€»ç»“-2" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-2"><span>æ€»ç»“ï¼š</span></a></h4><p>åœ¨ä¸€ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬é‡æ„äº†æœåŠ¡ç«¯çš„ä»£ç ï¼Œä»£ç æ›´åŠ ç®€æ´ï¼Œ</p><p>æ·»åŠ çº¿ç¨‹æ± ç‰ˆçš„æœåŠ¡ç«¯çš„å®ç°ï¼Œæ€§èƒ½åº”è¯¥ä¼šæœ‰æ‰€æå‡ï¼ˆæœªæµ‹ï¼‰</p><p>å¹¶ä¸”æœåŠ¡ç«¯ç»ˆäºèƒ½å¤Ÿæä¾›ä¸åŒæœåŠ¡äº†ï¼Œ åŠŸèƒ½æ›´åŠ å®Œå–„ï¼Œä¸å†é¸¡è‚‹</p><h4 id="æ­¤rpcæœ€å¤§çš„ç—›ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ­¤rpcæœ€å¤§çš„ç—›ç‚¹"><span>æ­¤RPCæœ€å¤§çš„ç—›ç‚¹</span></a></h4><ol><li>ä¼ ç»Ÿçš„BIOä¸çº¿ç¨‹æ± ç½‘ç»œä¼ è¾“æ€§èƒ½ä½</li></ol><hr><h3 id="_3-myrpcç‰ˆæœ¬3" tabindex="-1"><a class="header-anchor" href="#_3-myrpcç‰ˆæœ¬3"><span>3.MyRPCç‰ˆæœ¬3</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-4" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-4"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>nettyé«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶çš„ä½¿ç”¨</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-3" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-3"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><p>å¦‚ä½•æå‡è¿™ä¸ªrpcçš„æ€§èƒ½? å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢å…¥æ‰‹ï¼Œç½‘ç»œä¼ è¾“ä»BIOåˆ°NIOï¼Œåºåˆ—åŒ–è¦å‡å°‘å­—èŠ‚æµé•¿åº¦ï¼Œæé«˜åºåˆ—åŒ–ååºåˆ—åŒ–æ•ˆç‡</p><p>çŸ¥åçš„rpcæ¡†æ¶ï¼šdubboï¼Œ grpcéƒ½æ˜¯ä½¿ç”¨nettyåº•å±‚è¿›è¡Œé€šä¿¡çš„</p><h4 id="å‡çº§è¿‡ç¨‹" tabindex="-1"><a class="header-anchor" href="#å‡çº§è¿‡ç¨‹"><span>å‡çº§è¿‡ç¨‹ï¼š</span></a></h4><p><strong>å‰æï¼š</strong> maven pom.xmlæ–‡ä»¶å¼•å…¥netty</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>io<span class="token punctuation">.</span>netty<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>netty<span class="token operator">-</span>all<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span></span>
<span class="line">    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">4.1</span><span class="token number">.51</span><span class="token punctuation">.</span>Final<span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span></span>
<span class="line"><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‡çº§1ï¼š</strong> é‡æ„å®¢æˆ·ç«¯ä»£ç </p><p>å®¢æˆ·ç«¯çš„ä»£ç å¤ªä¹±äº†ï¼Œ æˆ‘ä»¬å…ˆè¿›è¡Œä»£ç é‡æ„ï¼Œæ‰æœ‰åˆ©äºåé¢ä½¿ç”¨nettyçš„æ–¹å¼å®ç°å®¢æˆ·ç«¯ï¼Œä½¿ä¹‹ä¸åŒæ–¹å¼ç½‘ç»œè¿æ¥çš„å®¢æˆ·ç«¯æœ‰ç€åŒæ ·çš„ç»“æ„ï¼ŒåŒæ ·çš„api</p><p>å‡å¦‚æˆ‘ä»¬ç°åœ¨å·²ç»æœ‰äº†ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼šSimpleRPCClient(ä½¿ç”¨java BIOçš„æ–¹å¼)ï¼Œ NettyRPCClientï¼ˆä½¿ç”¨nettyè¿›è¡Œç½‘ç»œä¼ è¾“ï¼‰ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸¤è€…çš„å…±æ€§æ˜¯å•¥?<strong>å‘é€è¯·æ±‚ä¸å¾—åˆ°response</strong>æ˜¯å…±æ€§ï¼Œ è€Œå»ºç«‹è¿æ¥ä¸å‘é€è¯·æ±‚çš„æ–¹å¼æ˜¯ä¸åŒç‚¹ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// å…±æ€§æŠ½å–å‡ºæ¥</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">RPCClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">RPCResponse</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">// SimpleRPCClientå®ç°è¿™ä¸ªæ¥å£ï¼Œä¸åŒçš„ç½‘ç»œæ–¹å¼æœ‰ç€ä¸åŒçš„å®ç°</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRPCClient</span> <span class="token keyword">implements</span> <span class="token class-name">RPCClient</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚è°ƒç”¨ï¼ŒSocketå»ºç«‹è¿æ¥ï¼Œå‘èµ·è¯·æ±‚Requestï¼Œå¾—åˆ°å“åº”Response</span></span>
<span class="line">    <span class="token comment">// è¿™é‡Œçš„requestæ˜¯å°è£…å¥½çš„ï¼Œä¸åŒçš„serviceéœ€è¦è¿›è¡Œä¸åŒçš„å°è£…ï¼Œ å®¢æˆ·ç«¯åªçŸ¥é“Serviceæ¥å£ï¼Œéœ€è¦ä¸€å±‚åŠ¨æ€ä»£ç†æ ¹æ®åå°„å°è£…ä¸åŒçš„Service</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RPCResponse</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å‘èµ·ä¸€æ¬¡Socketè¿æ¥è¯·æ±‚</span></span>
<span class="line">            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RPCResponse</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//System.out.println(response.getData());</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œ<strong>RPCClientProxy</strong>ç±»ä¸­éœ€è¦åŠ å…¥ä¸€ä¸ªRPCClientç±»å˜é‡å³å¯ï¼Œ ä¼ å…¥ä¸åŒçš„client(simple,netty), å³å¯è°ƒç”¨å…¬å…±çš„æ¥å£sendRequestå‘é€è¯·æ±‚ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä»£ç ç»“æ„å¾ˆæ¸…æ™°äº†:</p><ul><li><p><strong>RPCClient</strong>: ä¸åŒçš„ç½‘ç»œè¿æ¥ï¼Œç½‘ç»œä¼ è¾“æ–¹å¼çš„å®¢æˆ·ç«¯åˆ†åˆ«å®ç°è¿™ä¸ªæ¥å£</p></li><li><p><strong>XXXRPCClient:</strong> å…·ä½“å®ç°ç±»</p></li><li><p><strong>RPCClientProxyï¼š</strong> åŠ¨æ€ä»£ç†Serviceç±»ï¼Œå°è£…ä¸åŒçš„Serviceè¯·æ±‚ä¸ºRequestå¯¹è±¡ï¼Œå¹¶ä¸”æŒæœ‰ä¸€ä¸ªRPCClientå¯¹è±¡ï¼Œè´Ÿè´£ä¸æœåŠ¡ç«¯çš„é€šä¿¡ï¼Œ</p></li></ul><p>ç”±æ­¤ï¼Œå®¢æˆ·ç«¯ä»£ç é‡æ„å®Œæ¯•ï¼Œç»“æ„æ›´ä¸ºæ¸…æ™°ï¼Œä¸€ä¸ªä½¿ç”¨ç”¨ä¾‹ä¸ºï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// æ„å»ºä¸€ä¸ªä½¿ç”¨java Socketä¼ è¾“çš„å®¢æˆ·ç«¯</span></span>
<span class="line"><span class="token class-name">SimpleRPCClient</span> simpleRPCClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRPCClient</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// æŠŠè¿™ä¸ªå®¢æˆ·ç«¯ä¼ å…¥ä»£ç†å®¢æˆ·ç«¯</span></span>
<span class="line"><span class="token class-name">RPCClientProxy</span> rpcClientProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RPCClientProxy</span><span class="token punctuation">(</span>simpleRPCClient<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// ä»£ç†å®¢æˆ·ç«¯æ ¹æ®ä¸åŒçš„æœåŠ¡ï¼Œè·å¾—ä¸€ä¸ªä»£ç†ç±»ï¼Œ å¹¶ä¸”è¿™ä¸ªä»£ç†ç±»çš„æ–¹æ³•ä»¥æˆ–è€…å¢å¼ºï¼ˆå°è£…æ•°æ®ï¼Œå‘é€è¯·æ±‚ï¼‰</span></span>
<span class="line"><span class="token class-name">UserService</span> userService <span class="token operator">=</span> rpcClientProxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">// è°ƒç”¨æ–¹æ³•</span></span>
<span class="line"><span class="token class-name">User</span> userByUserId <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUserByUserId</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‡çº§2ï¼š</strong> ä½¿ç”¨nettyæ–¹å¼ä¼ è¾“æ•°æ®ï¼šå®ç°NettyRPCServerï¼Œ NettyRPCCLientï¼Œè¿™é‡Œå»ºè®®å…ˆå­¦ä¹ ä¸‹nettyçš„å¯åŠ¨ä»£ç </p><p><strong>netty æœåŠ¡ç«¯çš„å®ç°</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * å®ç°RPCServeræ¥å£ï¼Œè´Ÿè´£ç›‘å¬ä¸å‘é€æ•°æ®</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyRPCServer</span> <span class="token keyword">implements</span> <span class="token class-name">RPCServer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ServiceProvider</span> serviceProvider<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// netty æœåŠ¡çº¿ç¨‹ç»„bossè´Ÿè´£å»ºç«‹è¿æ¥ï¼Œ workè´Ÿè´£å…·ä½“çš„è¯·æ±‚</span></span>
<span class="line">        <span class="token class-name">NioEventLoopGroup</span> bossGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">NioEventLoopGroup</span> workGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;NettyæœåŠ¡ç«¯å¯åŠ¨äº†...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// å¯åŠ¨nettyæœåŠ¡å™¨</span></span>
<span class="line">            <span class="token class-name">ServerBootstrap</span> serverBootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// åˆå§‹åŒ–</span></span>
<span class="line">            serverBootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>bossGroup<span class="token punctuation">,</span>workGroup<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioServerSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyServerInitializer</span><span class="token punctuation">(</span>serviceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// åŒæ­¥é˜»å¡</span></span>
<span class="line">            <span class="token class-name">ChannelFuture</span> channelFuture <span class="token operator">=</span> serverBootstrap<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// æ­»å¾ªç¯ç›‘å¬</span></span>
<span class="line">            channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">            bossGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            workGroup<span class="token punctuation">.</span><span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>netty serveråˆå§‹åŒ–ç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * åˆå§‹åŒ–ï¼Œä¸»è¦è´Ÿè´£åºåˆ—åŒ–çš„ç¼–ç è§£ç ï¼Œ éœ€è¦è§£å†³nettyçš„ç²˜åŒ…é—®é¢˜</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyServerInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ServiceProvider</span> serviceProvider<span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ¶ˆæ¯æ ¼å¼ [é•¿åº¦][æ¶ˆæ¯ä½“], è§£å†³ç²˜åŒ…é—®é¢˜</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LengthFieldBasedFrameDecoder</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// è®¡ç®—å½“å‰å¾…å‘é€æ¶ˆæ¯çš„é•¿åº¦ï¼Œå†™å…¥åˆ°å‰4ä¸ªå­—èŠ‚ä¸­</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LengthFieldPrepender</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// è¿™é‡Œä½¿ç”¨çš„è¿˜æ˜¯java åºåˆ—åŒ–æ–¹å¼ï¼Œ nettyçš„è‡ªå¸¦çš„è§£ç ç¼–ç æ”¯æŒä¼ è¾“è¿™ç§ç»“æ„</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ObjectDecoder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token annotation punctuation">@Override</span></span>
<span class="line">            <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyRPCServerHandler</span><span class="token punctuation">(</span>serviceProvider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>netty serverå…·ä½“çš„handler</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * å› ä¸ºæ˜¯æœåŠ¡å™¨ç«¯ï¼Œæˆ‘ä»¬çŸ¥é“æ¥å—åˆ°è¯·æ±‚æ ¼å¼æ˜¯RPCRequest</span>
<span class="line"> * Objectç±»å‹ä¹Ÿè¡Œï¼Œå¼ºåˆ¶è½¬å‹å°±è¡Œ</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyRPCServerHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RPCRequest</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ServiceProvider</span> serviceProvider<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RPCRequest</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">//System.out.println(msg);</span></span>
<span class="line">        <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token function">getResponse</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token class-name">RPCResponse</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// å¾—åˆ°æœåŠ¡å</span></span>
<span class="line">        <span class="token class-name">String</span> interfaceName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å¾—åˆ°æœåŠ¡ç«¯ç›¸åº”æœåŠ¡å®ç°ç±»</span></span>
<span class="line">        <span class="token class-name">Object</span> service <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// åå°„è°ƒç”¨æ–¹æ³•</span></span>
<span class="line">        <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            method <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getMethodName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Object</span> invoke <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>invoke<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ–¹æ³•æ‰§è¡Œé”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯nettyçš„å®ç°</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * å®ç°RPCClientæ¥å£</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyRPCClient</span> <span class="token keyword">implements</span> <span class="token class-name">RPCClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Bootstrap</span> bootstrap<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">EventLoopGroup</span> eventLoopGroup<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">NettyRPCClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// nettyå®¢æˆ·ç«¯åˆå§‹åŒ–ï¼Œé‡å¤ä½¿ç”¨</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token punctuation">{</span></span>
<span class="line">        eventLoopGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        bootstrap<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span>eventLoopGroup<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token class-name">NioSocketChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyClientInitializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * è¿™é‡Œéœ€è¦æ“ä½œä¸€ä¸‹ï¼Œå› ä¸ºnettyçš„ä¼ è¾“éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä½ å‘é€requestï¼Œä¼šç«‹åˆ»è¿”å›ï¼Œ è€Œä¸æ˜¯æƒ³è¦çš„ç›¸åº”çš„response</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RPCResponse</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ChannelFuture</span> channelFuture  <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">Channel</span> channel <span class="token operator">=</span> channelFuture<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// å‘é€æ•°æ®</span></span>
<span class="line">            channel<span class="token punctuation">.</span><span class="token function">writeAndFlush</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            channel<span class="token punctuation">.</span><span class="token function">closeFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// é˜»å¡çš„è·å¾—ç»“æœï¼Œé€šè¿‡ç»™channelè®¾è®¡åˆ«åï¼Œè·å–ç‰¹å®šåå­—ä¸‹çš„channelä¸­çš„å†…å®¹ï¼ˆè¿™ä¸ªåœ¨hanlderä¸­è®¾ç½®ï¼‰</span></span>
<span class="line">            <span class="token comment">// AttributeKeyæ˜¯ï¼Œçº¿ç¨‹éš”ç¦»çš„ï¼Œä¸ä¼šç”±çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</span></span>
<span class="line">            <span class="token comment">// å®é™…ä¸Šä¸åº”é€šè¿‡é˜»å¡ï¼Œå¯é€šè¿‡å›è°ƒå‡½æ•°</span></span>
<span class="line">            <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RPCResponse</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;RPCResponse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå§‹åŒ–ï¼š ä¸æœåŠ¡ç«¯ä¸€è‡´ï¼Œå°±ä¸è´´ä»£ç äº†</p><p>ClientHandlerè®¾è®¡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientHandler</span> <span class="token keyword">extends</span> <span class="token class-name">SimpleChannelInboundHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RPCResponse</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">channelRead0</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">RPCResponse</span> msg<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æ¥æ”¶åˆ°response, ç»™channelè®¾è®¡åˆ«åï¼Œè®©sendRequesté‡Œè¯»å–response</span></span>
<span class="line">        <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RPCResponse</span><span class="token punctuation">&gt;</span></span> key <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;RPCResponse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exceptionCaught</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        cause<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ-3" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-3"><span>ç»“æœï¼š</span></a></h4><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200807172435854.png" alt="image-20200807172435854"></p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200807172418651.png" alt="image-20200807172418651"></p><h4 id="æ€»ç»“-3" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-3"><span>æ€»ç»“</span></a></h4><p>æ­¤ç‰ˆæœ¬æˆ‘ä»¬å®Œæˆäº†å®¢æˆ·ç«¯çš„é‡æ„ï¼Œä½¿ä¹‹èƒ½å¤Ÿæ”¯æŒå¤šç§ç‰ˆæœ¬å®¢æˆ·ç«¯çš„æ‰©å±•ï¼ˆå®ç°RPCClientæ¥å£ï¼‰</p><p>å¹¶ä¸”ä½¿ç”¨nettyå®ç°äº†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„é€šä¿¡</p><h4 id="æ­¤rpcæœ€å¤§ç—›ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ­¤rpcæœ€å¤§ç—›ç‚¹"><span>æ­¤RPCæœ€å¤§ç—›ç‚¹</span></a></h4><ol><li>javaè‡ªå¸¦åºåˆ—åŒ–æ–¹å¼ï¼ˆJavaåºåˆ—åŒ–å†™å…¥ä¸ä»…æ˜¯å®Œæ•´çš„ç±»åï¼Œä¹ŸåŒ…å«æ•´ä¸ªç±»çš„å®šä¹‰ï¼ŒåŒ…å«æ‰€æœ‰è¢«å¼•ç”¨çš„ç±»ï¼‰ï¼Œä¸å¤Ÿé€šç”¨ï¼Œä¸å¤Ÿé«˜æ•ˆ</li></ol><hr><h3 id="_4-myrpcç‰ˆæœ¬4" tabindex="-1"><a class="header-anchor" href="#_4-myrpcç‰ˆæœ¬4"><span>4.MyRPCç‰ˆæœ¬4</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-5" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-5"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>å„ç§åºåˆ—åŒ–æ–¹å¼ä»¥åŠæ¯”è¾ƒï¼Œï¼ˆJavaåŸç”Ÿåºåˆ—åŒ–ï¼Œ jsonï¼Œprotobufï¼Œkryo..ï¼‰<a href="https://www.jianshu.com/p/937883b6b2e5" target="_blank" rel="noopener noreferrer">å‚è€ƒåšå®¢</a></li><li>è‡ªå®šä¹‰åè®®</li><li>java IO äº†è§£</li><li>TCPç²˜åŒ…é—®é¢˜ï¼Œè§£å†³æ–¹å¼</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-4" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-4"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><ul><li><p>å¦‚ä½•è®¾è®¡å¹¶å®Œæˆè‡ªå·±çš„åè®®?</p><p>ç­”ï¼šè‡ªå·±å®ç°encodeä¸decode</p></li></ul><h4 id="å‡çº§è¿‡ç¨‹-1" tabindex="-1"><a class="header-anchor" href="#å‡çº§è¿‡ç¨‹-1"><span>å‡çº§è¿‡ç¨‹</span></a></h4><p>åœ¨å‰é¢çš„RPCç‰ˆæœ¬ä¸­ï¼Œ æˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨çš„javaè‡ªå¸¦çš„åºåˆ—åŒ–çš„æ–¹å¼ï¼Œäº‹å®ä¸Šä½¿ç”¨è¿™ç§æ–¹å¼æ€§èƒ½æ˜¯å¾ˆä½çš„ï¼ˆåºåˆ—åŒ–åçš„å­—èŠ‚æ•°ç»„ï¼Œ è§£ç ç¼–ç é€Ÿåº¦ï¼‰ï¼Œè€Œä¸”åœ¨nettyæœåŠ¡ç«¯ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯nettyè‡ªå¸¦çš„ç¼–ç å™¨ï¼Œç®€å•çš„ä¼ è¾“äº†ä¸€ä¸ª <strong>æ¶ˆæ¯é•¿åº¦ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰| åºåˆ—åŒ–åçš„æ•°æ®</strong> æ ¼å¼çš„æ•°æ®ã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬è¦è‡ªå®šä¹‰æˆ‘ä»¬çš„ä¼ è¾“æ ¼å¼å’Œç¼–è§£ç ã€‚</p><p>ä¸‹é¢æ˜¯æˆ‘çš„åˆæ­¥å¯¹æˆ‘çš„è‡ªå®šä¹‰æ ¼å¼çš„è®¾è®¡äº†ï¼Œ å…ˆè¯»å–æ¶ˆæ¯ç±»å‹ï¼ˆRequstï¼Œ Responseï¼Œ pingï¼Œ pongï¼‰ï¼Œ åºåˆ—åŒ–æ–¹å¼ï¼ˆåŸç”Ÿï¼Œ jsonï¼Œkryoï¼Œ protobuf..ï¼‰ï¼Œ åŠ ä¸Šæ¶ˆæ¯é•¿åº¦ï¼šé˜²æ­¢ç²˜åŒ…ï¼Œ å†æ ¹æ®é•¿åº¦è¯»å–data</p><table><thead><tr><th style="text-align:left;">æ¶ˆæ¯ç±»å‹ï¼ˆ2Byteï¼‰</th><th>åºåˆ—åŒ–æ–¹å¼ 2Byte</th><th>æ¶ˆæ¯é•¿åº¦ 4Byte</th></tr></thead><tbody><tr><td style="text-align:left;">åºåˆ—åŒ–åçš„Dataâ€¦.</td><td>åºåˆ—åŒ–åçš„Dataâ€¦</td><td>åºåˆ—åŒ–åçš„Dataâ€¦.</td></tr></tbody></table><p>å‰æå¤„ç†ï¼š maven pomæ–‡ä»¶ä¸­å¼•å…¥fastjsonåŒ…ï¼Œ RPCResponseä¸­éœ€è¦åŠ å…¥DataTypeå­—æ®µï¼Œå› ä¸ºå…¶å®ƒåºåˆ—åŒ–æ–¹å¼ï¼ˆjsonï¼‰æ— æ³•å¾—åˆ°Dataçš„ç±»å‹ï¼Œ</p><p><strong>å‡çº§1ï¼š</strong> è‡ªå®šä¹‰ç¼–è§£ç å™¨</p><p>åºåˆ—åŒ–å™¨çš„æ¥å£ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Serializer</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// æŠŠå¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„</span></span>
<span class="line">    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// ä»å­—èŠ‚æ•°ç»„ååºåˆ—åŒ–æˆæ¶ˆæ¯, ä½¿ç”¨javaè‡ªå¸¦åºåˆ—åŒ–æ–¹å¼ä¸ç”¨messageTypeä¹Ÿèƒ½å¾—åˆ°ç›¸åº”çš„å¯¹è±¡ï¼ˆåºåˆ—åŒ–å­—èŠ‚æ•°ç»„é‡ŒåŒ…å«ç±»ä¿¡æ¯ï¼‰</span></span>
<span class="line">    <span class="token comment">// å…¶å®ƒæ–¹å¼éœ€æŒ‡å®šæ¶ˆæ¯æ ¼å¼ï¼Œå†æ ¹æ®messageè½¬åŒ–æˆç›¸åº”çš„å¯¹è±¡</span></span>
<span class="line">    <span class="token class-name">Object</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// è¿”å›ä½¿ç”¨çš„åºåˆ—å™¨ï¼Œæ˜¯å“ªä¸ª</span></span>
<span class="line">    <span class="token comment">// 0ï¼šjavaè‡ªå¸¦åºåˆ—åŒ–æ–¹å¼, 1: jsonåºåˆ—åŒ–æ–¹å¼</span></span>
<span class="line">    <span class="token keyword">int</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// æ ¹æ®åºå·å–å‡ºåºåˆ—åŒ–å™¨ï¼Œæš‚æ—¶æœ‰ä¸¤ç§å®ç°æ–¹å¼ï¼Œéœ€è¦å…¶å®ƒæ–¹å¼ï¼Œå®ç°è¿™ä¸ªæ¥å£å³å¯</span></span>
<span class="line">    <span class="token keyword">static</span> <span class="token class-name">Serializer</span> <span class="token function">getSerializerByCode</span><span class="token punctuation">(</span><span class="token keyword">int</span> code<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjectSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>encodeç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * ä¾æ¬¡æŒ‰ç…§è‡ªå®šä¹‰çš„æ¶ˆæ¯æ ¼å¼å†™å…¥ï¼Œä¼ å…¥çš„æ•°æ®ä¸ºrequestæˆ–è€…response</span>
<span class="line"> * éœ€è¦æŒæœ‰ä¸€ä¸ªserializeå™¨ï¼Œè´Ÿè´£å°†ä¼ å…¥çš„å¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEncode</span> <span class="token keyword">extends</span> <span class="token class-name">MessageToByteEncoder</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Serializer</span> serializer<span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">encode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å†™å…¥æ¶ˆæ¯ç±»å‹</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RPCRequest</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            out<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span><span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">REQUEST</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            out<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span><span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">RESPONSE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// å†™å…¥åºåˆ—åŒ–æ–¹å¼</span></span>
<span class="line">        out<span class="token punctuation">.</span><span class="token function">writeShort</span><span class="token punctuation">(</span>serializer<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å¾—åˆ°åºåˆ—åŒ–æ•°ç»„</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serialize <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å†™å…¥é•¿åº¦</span></span>
<span class="line">        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>serialize<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// å†™å…¥åºåˆ—åŒ–å­—èŠ‚æ•°ç»„</span></span>
<span class="line">        out<span class="token punctuation">.</span><span class="token function">writeBytes</span><span class="token punctuation">(</span>serialize<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>decodeç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * æŒ‰ç…§è‡ªå®šä¹‰çš„æ¶ˆæ¯æ ¼å¼è§£ç æ•°æ®</span>
<span class="line"> */</span></span>
<span class="line"><span class="token annotation punctuation">@AllArgsConstructor</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyDecode</span> <span class="token keyword">extends</span> <span class="token class-name">ByteToMessageDecoder</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ByteBuf</span> in<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. è¯»å–æ¶ˆæ¯ç±»å‹</span></span>
<span class="line">        <span class="token keyword">short</span> messageType <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ç°åœ¨è¿˜åªæ”¯æŒrequestä¸responseè¯·æ±‚</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>messageType <span class="token operator">!=</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">REQUEST</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                messageType <span class="token operator">!=</span> <span class="token class-name">MessageType</span><span class="token punctuation">.</span><span class="token constant">RESPONSE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æš‚ä¸æ”¯æŒæ­¤ç§æ•°æ®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 2. è¯»å–åºåˆ—åŒ–çš„ç±»å‹</span></span>
<span class="line">        <span class="token keyword">short</span> serializerType <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// æ ¹æ®ç±»å‹å¾—åˆ°ç›¸åº”çš„åºåˆ—åŒ–å™¨</span></span>
<span class="line">        <span class="token class-name">Serializer</span> serializer <span class="token operator">=</span> <span class="token class-name">Serializer</span><span class="token punctuation">.</span><span class="token function">getSerializerByCode</span><span class="token punctuation">(</span>serializerType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span><span class="token punctuation">(</span>serializer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;ä¸å­˜åœ¨å¯¹åº”çš„åºåˆ—åŒ–å™¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 3. è¯»å–æ•°æ®åºåˆ—åŒ–åçš„å­—èŠ‚é•¿åº¦</span></span>
<span class="line">        <span class="token keyword">int</span> length <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// 4. è¯»å–åºåˆ—åŒ–æ•°ç»„</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        in<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ç”¨å¯¹åº”çš„åºåˆ—åŒ–å™¨è§£ç å­—èŠ‚æ•°ç»„</span></span>
<span class="line">        <span class="token class-name">Object</span> deserialize <span class="token operator">=</span> serializer<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        out<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>deserialize<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å‡çº§2ï¼š</strong> æ”¯æŒä¸åŒçš„åºåˆ—åŒ–å™¨</p><p><strong>Java åŸç”Ÿåºåˆ—åŒ–</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ObjectSerializer</span> <span class="token keyword">implements</span> <span class="token class-name">Serializer</span><span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// åˆ©ç”¨java IO å¯¹è±¡ -&gt; å­—èŠ‚æ•°ç»„</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ByteArrayOutputStream</span> bos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>bos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            oos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            bytes <span class="token operator">=</span> bos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            oos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            bos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> bytes<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å­—èŠ‚æ•°ç»„ -&gt; å¯¹è±¡</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> messageType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">ByteArrayInputStream</span> bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>bis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            obj <span class="token operator">=</span> ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            ois<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 0 ä»£è¡¨javaåŸç”Ÿåºåˆ—åŒ–å™¨</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>Jsonåºåˆ—åŒ–å™¨</strong></p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * ç”±äºjsonåºåˆ—åŒ–çš„æ–¹å¼æ˜¯é€šè¿‡æŠŠå¯¹è±¡è½¬åŒ–æˆå­—ç¬¦ä¸²ï¼Œä¸¢å¤±äº†Dataå¯¹è±¡çš„ç±»ä¿¡æ¯ï¼Œæ‰€ä»¥deserializeéœ€è¦</span>
<span class="line"> * äº†è§£å¯¹è±¡å¯¹è±¡çš„ç±»ä¿¡æ¯ï¼Œæ ¹æ®ç±»ä¿¡æ¯æŠŠJsonObject -&gt; å¯¹åº”çš„å¯¹è±¡</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonSerializer</span> <span class="token keyword">implements</span> <span class="token class-name">Serializer</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONBytes</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> bytes<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">deserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token keyword">int</span> messageType<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Object</span> obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ä¼ è¾“çš„æ¶ˆæ¯åˆ†ä¸ºrequestä¸response</span></span>
<span class="line">        <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageType<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span></span>
<span class="line">                <span class="token class-name">RPCRequest</span> request <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token class-name">RPCRequest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> objects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token comment">// æŠŠjsonå­—ä¸²è½¬åŒ–æˆå¯¹åº”çš„å¯¹è±¡ï¼Œ fastjsonå¯ä»¥è¯»å‡ºåŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸ç”¨è½¬åŒ–</span></span>
<span class="line">                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> objects<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> paramsType <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paramsType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                        objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJavaObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>request<span class="token punctuation">.</span><span class="token function">getParamsTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span></span>
<span class="line">                        objects<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                request<span class="token punctuation">.</span><span class="token function">setParams</span><span class="token punctuation">(</span>objects<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                obj <span class="token operator">=</span> request<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span></span>
<span class="line">                <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token class-name">RPCResponse</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dataType <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getDataType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span> dataType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">                    response<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJavaObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">)</span> response<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>dataType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                obj <span class="token operator">=</span> response<span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">break</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">default</span><span class="token operator">:</span></span>
<span class="line">                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æš‚æ—¶ä¸æ”¯æŒæ­¤ç§æ¶ˆæ¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    </span>
<span class="line">    <span class="token comment">// 1 ä»£è¡¨ç€jsonåºåˆ—åŒ–æ–¹å¼</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ-4" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-4"><span>ç»“æœ</span></a></h4><p>åœ¨nettyåˆå§‹åŒ–ç±»ï¼ˆå®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨ç«¯ï¼‰ä¸­æ·»åŠ è§£ç å™¨ä¸­ä½¿ç”¨è‡ªå·±å®šä¹‰çš„è§£ç å™¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NettyClientInitializer</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„ç¼–è§£ç å™¨</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyDecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// ç¼–ç éœ€è¦ä¼ å…¥åºåˆ—åŒ–å™¨ï¼Œè¿™é‡Œæ˜¯jsonï¼Œè¿˜æ”¯æŒObjectSerializerï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®ç°å…¶ä»–çš„</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyEncode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JsonSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NettyClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200809161933283.png" alt="image-20200809161933283"></p><p>æˆåŠŸå¯åŠ¨!</p><h4 id="æ€»ç»“-4" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-4"><span>æ€»ç»“</span></a></h4><p>åœ¨è¿™ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„æ¶ˆæ¯æ ¼å¼ï¼Œä½¿ä¹‹æ”¯æŒå¤šç§æ¶ˆæ¯ç±»å‹ï¼Œåºåˆ—åŒ–æ–¹å¼ï¼Œä½¿ç”¨æ¶ˆæ¯å¤´åŠ é•¿åº¦çš„æ–¹å¼è§£å†³ç²˜åŒ…é—®é¢˜</p><p>å¹¶ä¸”ï¼Œå®ç°äº†ObjectSerializerä¸JsonSerializerä¸¤ç§åºåˆ—åŒ–å™¨ï¼Œä¹Ÿå¯ä»¥è½»æ¾æ‰©å±•ä¸ºå…¶å®ƒåºåˆ—åŒ–æ–¹å¼ï¼ˆå®ç°Serializeæ¥å£ï¼‰ã€‚</p><h4 id="æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹" tabindex="-1"><a class="header-anchor" href="#æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹"><span>æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹</span></a></h4><ul><li>æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯é€šä¿¡çš„hostä¸porté¢„å…ˆå°±å¿…é¡»çŸ¥é“çš„ï¼Œæ¯ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½å¿…é¡»çŸ¥é“å¯¹åº”æœåŠ¡çš„ipä¸ç«¯å£å·ï¼Œ å¹¶ä¸”å¦‚æœæœåŠ¡æŒ‚äº†æˆ–è€…æ¢åœ°å€äº†ï¼Œå°±å¾ˆéº»çƒ¦ã€‚æ‰©å±•æ€§ä¹Ÿä¸å¼º</li></ul><hr><h3 id="_5-myrpcç‰ˆæœ¬5" tabindex="-1"><a class="header-anchor" href="#_5-myrpcç‰ˆæœ¬5"><span>5.MyRPCç‰ˆæœ¬5</span></a></h3><h4 id="èƒŒæ™¯çŸ¥è¯†-6" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-6"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>zookeeperå®‰è£…ï¼Œ åŸºæœ¬æ¦‚å¿µ</li><li>äº†è§£curatorå¼€æºzookeeperå®¢æˆ·ç«¯ä¸­çš„ä½¿ç”¨</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-5" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-5"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><ul><li>å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒ</li></ul><p>æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚zookeeperï¼‰çš„åœ°å€æ˜¯å›ºå®šçš„ï¼ˆä¸ºäº†é«˜å¯ç”¨ä¸€èˆ¬æ˜¯é›†ç¾¤ï¼Œæˆ‘ä»¬çœ‹åšé»‘ç›’å³å¯ï¼‰ï¼Œ æœåŠ¡ç«¯ä¸Šçº¿æ—¶ï¼Œåœ¨æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±çš„æœåŠ¡ä¸å¯¹åº”çš„åœ°å€ï¼Œè€Œå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡æ—¶ï¼Œå»æ³¨å†Œä¸­å¿ƒæ ¹æ®æœåŠ¡åæ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ç«¯åœ°å€ã€‚</p><p>zookeeperæˆ‘ä»¬å¯ä»¥è¿‘ä¼¼çœ‹ä½œä¸€ä¸ªæ ‘å½¢ç›®å½•æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼åè°ƒåº”ç”¨ï¼Œå…¶å®ƒæ³¨å†Œä¸­å¿ƒæœ‰EureKaï¼Œ Nacosç­‰</p><h4 id="å‡çº§è¿‡ç¨‹-2" tabindex="-1"><a class="header-anchor" href="#å‡çº§è¿‡ç¨‹-2"><span>å‡çº§è¿‡ç¨‹</span></a></h4><p><strong>å‰æ</strong></p><ol><li>ä¸‹è½½è§£å‹Zookeeper [åœ°å€]ï¼ˆhttps://zookeeper.apache.org/releases.htmlï¼‰</li><li>å­¦ä¹ ä¸€ä¸ªzookeeperå¯åŠ¨çš„ä¾‹å­ <a href="https://zookeeper.apache.org/doc/current/zookeeperStarted.html#sc_Download" target="_blank" rel="noopener noreferrer">å®˜æ–¹ä¾‹å­</a><ol><li>zoo.cfg ä¿®æ”¹dataDirä¸ºä¸€ä¸ªå­˜åœ¨ç›®å½•</li><li>windowså¯åŠ¨å‘½ä»¤: bin/zkServer.cmd</li></ol></li><li>javaé¡¹ç›®ä¸­å¼•å…¥Curatorå®¢æˆ·ç«¯ï¼Œ</li></ol><div class="language-xml line-numbers-mode" data-ext="xml" data-title="xml"><pre class="language-xml"><code><span class="line"><span class="token comment">&lt;!--è¿™ä¸ªjaråŒ…åº”è¯¥ä¾èµ–log4j,ä¸å¼•å…¥log4jä¼šæœ‰æ§åˆ¶å°ä¼šæœ‰warnï¼Œä½†ä¸å½±å“æ­£å¸¸ä½¿ç”¨--&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°1</strong> ï¼š å¼•å…¥zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒ</p><p>å¯åŠ¨æœ¬åœ°zookeeperæœåŠ¡ç«¯ï¼Œé»˜è®¤ç«¯å£2181ã€‚zookeeperå®¢æˆ·ç«¯æµ‹è¯•å¦‚ä¸‹ï¼š</p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200810105040168.png" alt="image-20200810105040168"></p><p>å…ˆå®šä¹‰æœåŠ¡æ³¨å†Œæ¥å£</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// æœåŠ¡æ³¨å†Œæ¥å£ï¼Œä¸¤å¤§åŸºæœ¬åŠŸèƒ½ï¼Œæ³¨å†Œï¼šä¿å­˜æœåŠ¡ä¸åœ°å€ã€‚ æŸ¥è¯¢ï¼šæ ¹æ®æœåŠ¡åæŸ¥æ‰¾åœ°å€</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServiceRegister</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span> serverAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name">InetSocketAddress</span> <span class="token function">serviceDiscovery</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>zookeeperæœåŠ¡æ³¨å†Œæ¥å£çš„å®ç°ç±»</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZkServiceRegister</span> <span class="token keyword">implements</span> <span class="token class-name">ServiceRegister</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// curator æä¾›çš„zookeeperå®¢æˆ·ç«¯</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">CuratorFramework</span> client<span class="token punctuation">;</span></span>
<span class="line">    <span class="token comment">// zookeeperæ ¹è·¯å¾„èŠ‚ç‚¹</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">ROOT_PATH</span> <span class="token operator">=</span> <span class="token string">&quot;MyRPC&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// è¿™é‡Œè´Ÿè´£zookeeperå®¢æˆ·ç«¯çš„åˆå§‹åŒ–ï¼Œå¹¶ä¸zookeeperæœåŠ¡ç«¯å»ºç«‹è¿æ¥</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ZkServiceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// æŒ‡æ•°æ—¶é—´é‡è¯•</span></span>
<span class="line">        <span class="token class-name">RetryPolicy</span> policy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token comment">// zookeeperçš„åœ°å€å›ºå®šï¼Œä¸ç®¡æ˜¯æœåŠ¡æä¾›è€…è¿˜æ˜¯ï¼Œæ¶ˆè´¹è€…éƒ½è¦ä¸ä¹‹å»ºç«‹è¿æ¥</span></span>
<span class="line">        <span class="token comment">// sessionTimeoutMs ä¸ zoo.cfgä¸­çš„tickTime æœ‰å…³ç³»ï¼Œ</span></span>
<span class="line">        <span class="token comment">// zkè¿˜ä¼šæ ¹æ®minSessionTimeoutä¸maxSessionTimeoutä¸¤ä¸ªå‚æ•°é‡æ–°è°ƒæ•´æœ€åçš„è¶…æ—¶å€¼ã€‚é»˜è®¤åˆ†åˆ«ä¸ºtickTime çš„2å€å’Œ20å€</span></span>
<span class="line">        <span class="token comment">// ä½¿ç”¨å¿ƒè·³ç›‘å¬çŠ¶æ€</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:2181&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">40000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">namespace</span><span class="token punctuation">(</span><span class="token constant">ROOT_PATH</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;zookeeper è¿æ¥æˆåŠŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">,</span> <span class="token class-name">InetSocketAddress</span> serverAddress<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// serviceNameåˆ›å»ºæˆæ°¸ä¹…èŠ‚ç‚¹ï¼ŒæœåŠ¡æä¾›è€…ä¸‹çº¿æ—¶ï¼Œä¸åˆ æœåŠ¡åï¼Œåªåˆ åœ°å€</span></span>
<span class="line">            <span class="token keyword">if</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">checkExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">               client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token comment">// è·¯å¾„åœ°å€ï¼Œä¸€ä¸ª/ä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹</span></span>
<span class="line">            <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> serviceName <span class="token operator">+</span><span class="token string">&quot;/&quot;</span><span class="token operator">+</span> <span class="token function">getServiceAddress</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// ä¸´æ—¶èŠ‚ç‚¹ï¼ŒæœåŠ¡å™¨ä¸‹çº¿å°±åˆ é™¤èŠ‚ç‚¹</span></span>
<span class="line">            client<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">creatingParentsIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;æ­¤æœåŠ¡å·²å­˜åœ¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// æ ¹æ®æœåŠ¡åè¿”å›åœ°å€</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">serviceDiscovery</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// è¿™é‡Œé»˜è®¤ç”¨çš„ç¬¬ä¸€ä¸ªï¼Œåé¢åŠ è´Ÿè½½å‡è¡¡</span></span>
<span class="line">            <span class="token class-name">String</span> string <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token function">parseAddress</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// åœ°å€ -&gt; XXX.XXX.XXX.XXX:port å­—ç¬¦ä¸²</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getServiceAddress</span><span class="token punctuation">(</span><span class="token class-name">InetSocketAddress</span> serverAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> serverAddress<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span></span>
<span class="line">                <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span></span>
<span class="line">                serverAddress<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// å­—ç¬¦ä¸²è§£æä¸ºåœ°å€</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">InetSocketAddress</span> <span class="token function">parseAddress</span><span class="token punctuation">(</span><span class="token class-name">String</span> address<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ›´æ–°</strong>2ï¼š æ›´æ–°å®¢æˆ·ç«¯å¾—åˆ°æœåŠ¡å™¨çš„æ–¹å¼ï¼Œ æœåŠ¡ç«¯æš´éœ²æœåŠ¡æ—¶ï¼Œæ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ</p><p>é¦–å…ˆnew clientä¸éœ€è¦ä¼ å…¥hostä¸nameï¼Œ è€Œåœ¨å‘é€requestæ—¶ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å¾—</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token comment">// ä¸éœ€ä¼ hostï¼Œport</span></span>
<span class="line"><span class="token class-name">RPCClient</span> rpcClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRPCClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å®¢æˆ·ç«¯çš„æ”¹é€ </p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleRPCClient</span> <span class="token keyword">implements</span> <span class="token class-name">RPCClient</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ServiceRegister</span> serviceRegister<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">SimpleRPCClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// åˆå§‹åŒ–æ³¨å†Œä¸­å¿ƒï¼Œå»ºç«‹è¿æ¥</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegister <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkServiceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// å®¢æˆ·ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚è°ƒç”¨ï¼ŒSocketå»ºç«‹è¿æ¥ï¼Œå‘èµ·è¯·æ±‚Requestï¼Œå¾—åˆ°å“åº”Response</span></span>
<span class="line">    <span class="token comment">// è¿™é‡Œçš„requestæ˜¯å°è£…å¥½çš„ï¼Œä¸åŒçš„serviceéœ€è¦è¿›è¡Œä¸åŒçš„å°è£…ï¼Œ å®¢æˆ·ç«¯åªçŸ¥é“Serviceæ¥å£ï¼Œéœ€è¦ä¸€å±‚åŠ¨æ€ä»£ç†æ ¹æ®åå°„å°è£…ä¸åŒçš„Service</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">RPCResponse</span> <span class="token function">sendRequest</span><span class="token punctuation">(</span><span class="token class-name">RPCRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// ä»æ³¨å†Œä¸­å¿ƒè·å–hostï¼Œport</span></span>
<span class="line">        <span class="token class-name">InetSocketAddress</span> address <span class="token operator">=</span> serviceRegister<span class="token punctuation">.</span><span class="token function">serviceDiscovery</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInterfaceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        host <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        port <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        </span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">ObjectOutputStream</span> objectOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">ObjectInputStream</span> objectInputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            objectOutputStream<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name">RPCResponse</span> response <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RPCResponse</span><span class="token punctuation">)</span> objectInputStream<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//System.out.println(response.getData());</span></span>
<span class="line">            <span class="token keyword">return</span> response<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> <span class="token operator">|</span> <span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœåŠ¡ç«¯çš„æ”¹é€ ï¼šæœåŠ¡ç«¯åè€Œéœ€è¦æŠŠè‡ªå·±çš„ipï¼Œç«¯å£ç»™æ³¨å†Œä¸­å¿ƒ</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token class-name">ServiceProvider</span> serviceProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceProvider</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>åœ¨æœåŠ¡æš´éœ²ç±»åŠ å…¥æ³¨å†Œçš„åŠŸèƒ½</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceProvider</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token doc-comment comment">/**</span>
<span class="line">     * ä¸€ä¸ªå®ç°ç±»å¯èƒ½å®ç°å¤šä¸ªæœåŠ¡æ¥å£ï¼Œ</span>
<span class="line">     */</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> interfaceProvider<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">ServiceRegister</span> serviceRegister<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token class-name">String</span> host<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">ServiceProvider</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// éœ€è¦ä¼ å…¥æœåŠ¡ç«¯è‡ªèº«çš„æœåŠ¡çš„ç½‘ç»œåœ°å€</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>host <span class="token operator">=</span> host<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>interfaceProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceRegister <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZkServiceRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">provideServiceInterface</span><span class="token punctuation">(</span><span class="token class-name">Object</span> service<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Class</span> clazz <span class="token operator">:</span> interfaces<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">// æœ¬æœºçš„æ˜ å°„è¡¨</span></span>
<span class="line">            interfaceProvider<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// åœ¨æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡</span></span>
<span class="line">            serviceRegister<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getService</span><span class="token punctuation">(</span><span class="token class-name">String</span> interfaceName<span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> interfaceProvider<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç»“æœ-5" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-5"><span>ç»“æœ</span></a></h4><p>æˆåŠŸè¿è¡Œï¼</p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200810113516390.png" alt="image-20200810113516390"></p><h4 id="æ€»ç»“-5" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-5"><span>æ€»ç»“</span></a></h4><p>æ­¤ç‰ˆæœ¬ä¸­æˆ‘ä»¬åŠ å…¥äº†æ³¨å†Œä¸­å¿ƒï¼Œç»ˆäºä¸€ä¸ªå®Œæ•´çš„RPCæ¡†æ¶ä¸‰ä¸ªè§’è‰²éƒ½æœ‰äº†ï¼šæœåŠ¡æä¾›è€…ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œæ³¨å†Œä¸­å¿ƒ</p><h4 id="æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹-1" tabindex="-1"><a class="header-anchor" href="#æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹-1"><span>æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹</span></a></h4><ul><li>æ ¹æ®æœåŠ¡åæŸ¥è¯¢åœ°å€æ—¶ï¼Œæˆ‘ä»¬è¿”å›çš„æ€»æ˜¯ç¬¬ä¸€ä¸ªIPï¼Œå¯¼è‡´è¿™ä¸ªæä¾›è€…å‹åŠ›å·¨å¤§ï¼Œè€Œå…¶å®ƒæä¾›è€…è°ƒç”¨ä¸åˆ°</li></ul><hr><h3 id="_6-myrpcç‰ˆæœ¬6" tabindex="-1"><a class="header-anchor" href="#_6-myrpcç‰ˆæœ¬6"><span>6.MyRPCç‰ˆæœ¬6</span></a></h3><p>æˆ‘ä»¬çš„RPCæ€»ä½“æ¡†æ¶å·²ç»æœ‰äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸€äº›ä¿®ä¿®è¡¥è¡¥å·²ç»æ‰©å±•åŠŸèƒ½çš„æ¨¡å—äº†</p><h4 id="èƒŒæ™¯çŸ¥è¯†-7" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯çŸ¥è¯†-7"><span>èƒŒæ™¯çŸ¥è¯†</span></a></h4><ul><li>è´Ÿè½½å‡è¡¡</li></ul><h4 id="æœ¬èŠ‚é—®é¢˜-6" tabindex="-1"><a class="header-anchor" href="#æœ¬èŠ‚é—®é¢˜-6"><span>æœ¬èŠ‚é—®é¢˜</span></a></h4><ul><li>å¦‚æœä¸€ä¸ªæœåŠ¡æœ‰å¤šä¸ªæä¾›è€…æ”¯æŒï¼Œå¦‚ä½•åˆ†æ•£æœåŠ¡æä¾›è€…çš„å‹åŠ›</li></ul><h4 id="å‡çº§è¿‡ç¨‹-3" tabindex="-1"><a class="header-anchor" href="#å‡çº§è¿‡ç¨‹-3"><span>å‡çº§è¿‡ç¨‹</span></a></h4><ol><li>è´Ÿè½½å‡è¡¡æ¥å£</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * ç»™æœåŠ¡å™¨åœ°å€åˆ—è¡¨ï¼Œæ ¹æ®ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ª</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">LoadBalance</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">String</span> <span class="token function">balance</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addressList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>ä¸¤ç§å®ç°æ–¹å¼</li></ol><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * éšæœºè´Ÿè½½å‡è¡¡</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RandomLoadBalance</span> <span class="token keyword">implements</span>  <span class="token class-name">LoadBalance</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">balance</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addressList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Random</span> random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">int</span> choose <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>addressList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è´Ÿè½½å‡è¡¡é€‰æ‹©äº†&quot;</span> <span class="token operator">+</span> choose <span class="token operator">+</span> <span class="token string">&quot;æœåŠ¡å™¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> addressList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>choose<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * è½®è¯¢è´Ÿè½½å‡è¡¡</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoundLoadBalance</span> <span class="token keyword">implements</span> <span class="token class-name">LoadBalance</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">int</span> choose <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token annotation punctuation">@Override</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">balance</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addressList<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        choose<span class="token operator">++</span><span class="token punctuation">;</span></span>
<span class="line">        choose <span class="token operator">=</span> choose<span class="token operator">%</span>addressList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> addressList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>choose<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨<strong>æœåŠ¡å‘ç°æ–¹æ³•</strong>ä¸­ä½¿ç”¨è´Ÿè½½å‡è¡¡</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="line"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forPath</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="ç»“æœ-6" tabindex="-1"><a class="header-anchor" href="#ç»“æœ-6"><span>ç»“æœ</span></a></h4><p>æˆ‘ä»¬å¼€å¯ä¸¤å°æœåŠ¡æä¾›è€…</p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200810145905597.png" alt="image-20200810145905597"></p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200810145920503.png" alt="image-20200810145920503"></p><p><img src="http://ganghuan.oss-cn-shenzhen.aliyuncs.com/img/image-20200810145934491.png" alt="image-20200810145934491"></p><p>å¯ä»¥çœ‹å‡ºè´Ÿè½½å‡è¡¡ç­–ç•¥å·²ç»æˆåŠŸ</p><h4 id="æ€»ç»“-6" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“-6"><span>æ€»ç»“</span></a></h4><p>è¿™ä¸€ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å®ç°è´Ÿè½½å‡è¡¡çš„ä¸¤ç§ç­–ç•¥ï¼šéšæœºä¸è½®è¯¢ã€‚</p><p>åœ¨è¿™ä¸€ç‰ˆæœ¬ä¸‹ï¼Œä¸€ä¸ªå®Œæ•´åŠŸèƒ½çš„RPCå·²ç»å‡ºç°ï¼Œå½“ç„¶è¿˜æœ‰è®¸å¤šæ€§èƒ½ä¸Šä¸ä»£ç è´¨é‡ä¸Šçš„å·¥ä½œéœ€è¦å®Œæˆã€‚</p><h4 id="æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹-2" tabindex="-1"><a class="header-anchor" href="#æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹-2"><span>æ­¤ç‰ˆæœ¬æœ€å¤§ç—›ç‚¹</span></a></h4><ul><li>å®¢æˆ·ç«¯æ¯æ¬¡å‘èµ·è¯·æ±‚éƒ½è¦å…ˆä¸zookeeperè¿›è¡Œé€šä¿¡å¾—åˆ°åœ°å€ï¼Œæ•ˆç‡ä½ä¸‹ã€‚</li></ul></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 2961819202@qq.com">jikenu</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/article/java/project/ORM.html" aria-label="ORMç¤ºä¾‹"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">ORMç¤ºä¾‹<!----></div></a></nav><!----><!----><!--]--></main><!--]--><!----></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BKdByfKa.js" defer></script>
  </body>
</html>
